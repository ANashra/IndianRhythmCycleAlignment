<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Cycle Alignment Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-box-sizing: border-box; /* Safari compatibility */
            -moz-box-sizing: border-box; /* Firefox compatibility */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
            /* Safari-specific fixes */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* Safari compatibility */
        }

        h1 {
            text-align: center;
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .participant-id {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-align: center;
            font-family: monospace;
            font-weight: bold;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .trial-progress {
            background: linear-gradient(135deg, #4f7942 0%, #2d5016 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            font-size: 1.1em;
            box-shadow: 0 4px 15px rgba(79, 121, 66, 0.3);
        }

        .status {
            background: rgba(66, 153, 225, 0.1);
            border: 1px solid #4299e1;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
        }

        .status.success { 
            background: rgba(72, 187, 120, 0.1); 
            border-color: #48bb78; 
            color: #2f855a; 
        }

        .status.warning { 
            background: rgba(237, 137, 54, 0.1); 
            border-color: #ed8936; 
            color: #c05621; 
        }

        .status.error { 
            background: rgba(229, 62, 62, 0.1); 
            border-color: #e53e3e; 
            color: #c53030; 
        }

        .btn {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 8px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(66, 153, 225, 0.3);
            /* Cross-browser button fixes */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.4);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #48bb78, #38a169);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .btn-submit {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            font-size: 1.3em;
            padding: 18px 40px;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .btn-submit:hover {
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.4);
        }

        .btn-next {
            background: linear-gradient(45deg, #9f7aea, #805ad5);
            font-size: 1.2em;
            padding: 16px 35px;
            box-shadow: 0 4px 15px rgba(159, 122, 234, 0.3);
        }

        .btn-next:hover {
            box-shadow: 0 8px 25px rgba(159, 122, 234, 0.4);
        }

        .control-panel {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 15px;
            border-radius: 12px;
            margin: 5px 0;
            border: 1px solid #e2e8f0;
        }

        .beat-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 8px 0 5px 0;
        }

        .beat-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Safari button fixes */
            -webkit-appearance: none;
            outline: none;
        }

        .beat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .beat-btn:active {
            transform: scale(0.95);
        }

        .beat-display {
            background: rgba(102, 126, 234, 0.1);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin: 8px 0;
        }

        .wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
            padding: 25px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
        }

        .wheel-label {
            font-size: 1.1em;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 20px;
        }

        .timing-wheel {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 20px 0;
            pointer-events: none;
        }

        .wheel-base {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 3px solid #e2e8f0;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1), 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .wheel-tick {
            position: absolute;
            width: 3px;
            height: 20px;
            background: #a0aec0;
            border-radius: 1.5px;
            transform-origin: 50% 100px;
            top: 10px;
            left: 50%;
            margin-left: -1.5px;
        }

        .wheel-tick.start-position {
            background: #4299e1;
            width: 4px;
            height: 25px;
            margin-left: -2px;
            top: 7.5px;
            box-shadow: 0 2px 6px rgba(66, 153, 225, 0.4);
        }

        .wheel-pointer {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            top: 0px;
            left: 50%;
            transform-origin: 50% 100px;
            margin-left: -10px;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.5);
            transition: transform 0.4s ease;
            z-index: 10;
            border: 3px solid white;
        }

        .wheel-center {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            top: 50%;
            left: 50%;
            margin: -10px 0 0 -10px;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
            z-index: 15;
        }

        .wheel-labels {
            text-align: center;
            font-size: 0.9em;
            color: #718096;
            margin-top: 15px;
            font-weight: 500;
        }

        .info-box {
            background: linear-gradient(135deg, #ebf8ff, #bee3f8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3182ce;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 8px 0;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.8);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #4299e1;
        }

        .instructions h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .instructions ul {
            color: #4a5568;
            line-height: 1.6;
        }

        .instructions li {
            margin: 8px 0;
        }

        input[type="text"], input[type="number"] {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin: 8px;
            font-size: 1em;
            width: 200px;
            transition: border-color 0.3s ease;
            /* Safari input fixes */
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #4299e1;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #48bb78, #38a169);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .experiment-progress {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }

        .progress-bar-container {
            margin: 10px 0;
        }

        .progress-text {
            text-align: center;
            color: #4a5568;
            font-weight: 500;
            margin-bottom: 8px;
        }

        /* Enhanced Mobile Responsive Styles */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                margin: 5px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 2em;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 1em;
                margin-bottom: 20px;
            }
            
            .beat-controls {
                gap: 15px;
                margin: 5px 0;
            }
            
            .beat-btn {
                width: 50px;
                height: 50px;
                font-size: 1.4em;
            }
            
            .wheel-container {
                margin: 15px 0;
                padding: 15px;
            }
            
            .timing-wheel {
                width: 150px;
                height: 150px;
                margin: 10px 0;
            }
            
            .wheel-base {
                border: 2px solid #e2e8f0;
            }
            
            .wheel-pointer {
                width: 16px;
                height: 16px;
                margin-left: -8px;
                transform-origin: 50% 75px;
                border: 2px solid white;
            }
            
            .wheel-center {
                width: 16px;
                height: 16px;
                margin: -8px 0 0 -8px;
            }
            
            .control-panel {
                padding: 10px;
                margin: 3px 0;
            }
            
            .beat-display {
                padding: 8px;
                margin: 5px 0;
                font-size: 0.9em;
            }
            
            .btn {
                padding: 10px 20px;
                margin: 5px;
                font-size: 0.9em;
            }
            
            .btn-submit {
                font-size: 1.1em;
                padding: 15px 30px;
            }
            
            .btn-next {
                font-size: 1em;
                padding: 12px 25px;
            }
            
            .btn-primary {
                padding: 15px 30px;
                font-size: 1em;
            }
            
            .instructions {
                padding: 15px;
                margin: 15px 0;
            }
            
            .info-box {
                padding: 15px;
                margin: 15px 0;
            }
            
            .status {
                padding: 10px;
                margin: 10px 0;
                font-size: 0.9em;
            }
            
            .trial-progress {
                padding: 10px 15px;
                margin: 10px 0;
                font-size: 1em;
            }
            
            #practice-feedback {
                margin: 5px 0;
                padding: 10px;
            }
            
            #beat-position-display {
                font-size: 1.1em !important;
            }
            
            .wheel-label {
                font-size: 1em;
                margin-bottom: 10px;
            }
            
            .wheel-labels {
                font-size: 0.8em;
                margin-top: 8px;
            }
            
            input[type="text"], input[type="number"] {
                width: 100%;
                margin: 5px 0;
                padding: 10px 12px;
            }
            
            textarea {
                width: 100% !important;
                min-height: 100px !important;
                padding: 12px !important;
                font-size: 0.9em !important;
            }
            
            select {
                width: 100% !important;
                padding: 10px 12px !important;
                font-size: 0.9em !important;
            }
        }
        
        /* Safari-specific fixes */
        @supports (-webkit-appearance: none) {
            .btn, .beat-btn {
                -webkit-transform: translateZ(0);
                backface-visibility: hidden;
            }
            
            .wheel-pointer {
                -webkit-transform-origin: 50% 100px;
            }
            
            @media (max-width: 600px) {
                .wheel-pointer {
                    -webkit-transform-origin: 50% 75px;
                }
            }
        }
        
        /* Additional mobile viewport fixes */
        @media screen and (max-height: 667px) and (max-width: 600px) {
            .container {
                padding: 12px;
            }
            
            .wheel-container {
                margin: 10px 0;
                padding: 10px;
            }
            
            .instructions {
                padding: 12px;
                margin: 10px 0;
            }
            
            .info-box {
                padding: 12px;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="welcome-screen">
            <h1>Rhythm Cycle Alignment Study</h1>
            <p class="subtitle">Rhythm Perception Research</p>
            
            <div style="margin: 40px 0;">
                <button class="btn btn-submit" onclick="startExperiment()">Enter Study</button>
            </div>
        </div>
        
        <div id="experiment-content" style="display: none;">
            <!-- Experiment content will be inserted here -->
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_FORMS: {
                form_url: 'https://docs.google.com/forms/d/e/1FAIpQLSe_FwttiN7E5Ma-8PWgjhbXGww96pp20rOQJdjvZHOw3mLQkw/formResponse',
                fields: {
                    participant_id: 'entry.1163885589',
                    trial_data: 'entry.112861185',
                    age: 'entry.271345687',
                    strategies: 'entry.883232585'
                }
            },
            PRACTICE: {
                example_audio: 'audio/Drum_Example.mp3',
                practice1: {
                    name: 'Practice 1',
                    stm1: 'audio/Stm1_Practice1.mp3',
                    stm2: 'audio/Stm2_Practice1.mp3',
                    beats_per_cycle: 4,
                    beat_duration: 0.37
                },
                practice2: {
                    name: 'Practice 2',
                    stm1: 'audio/Stm1_Practice2.mp3',
                    stm2: 'audio/Stm2_Practice2.mp3',
                    beats_per_cycle: 6,
                    beat_duration: 0.30
                }
            },
            RHYTHMS: [
                {
                    name: 'Jhaptal',
                    stm1: 'audio/Jhaptal_Stm1_5.mp3',
                    stm2: 'audio/Jhaptal_Stm2_5.mp3',
                    beats_per_cycle: 10,
                    beat_duration: 0.500,
                    total_cycles: 24
                },
                {
                    name: 'Keherva',
                    stm1: 'audio/Keherva_Stm1_5.mp3',
                    stm2: 'audio/Keherva_Stm2_5.mp3',
                    beats_per_cycle: 8,
                    beat_duration: 0.625,
                    total_cycles: 24
                },
                {
                    name: 'Rupak',
                    stm1: 'audio/Rupak_Stm1_5.mp3',
                    stm2: 'audio/Rupak_Stm2_5.mp3',
                    beats_per_cycle: 7,
                    beat_duration: 0.714286,
                    total_cycles: 24
                },
                {
                    name: 'Teental',
                    stm1: 'audio/Teental_Stm1_5.mp3',
                    stm2: 'audio/Teental_Stm2_5.mp3',
                    beats_per_cycle: 16,
                    beat_duration: 0.3125,
                    total_cycles: 24
                }
            ],
            REPETITIONS: 2
        };
        
        // Global variables
        let audioContext;
        let audioBuffers = { rhythm: null, tones: null };
        let audioSources = { rhythm: null, tones: null };
        let gainNodes = { rhythm: null, tones: null };
        
        let participantId = 'RHYTHM_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        
        let experimentTrials = [];
        let currentTrialIndex = 0;
        let currentTrial = null;
        let participantAge = '';
        
        let currentBeatOffset = 0;
        let initialBeatOffset = 0;
        let isPlaying = false;
        let currentPlaybackPosition = 0;
        let playbackStartTime = 0;
        let isFirstPlay = true;
        let trialStartTime = 0;
        let adjustmentCount = 0;
        let allTrialData = [];
        let cumulativeWheelAngle = 0; // Track cumulative wheel rotation
        
        let practiceStage = 0;
        let currentPractice = null;
        let practiceStartTime = 0;
        let exampleAudioBuffer = null;
        let exampleAudioSource = null;
        let isExamplePlaying = false;
        
        let surveyData = {
            indianMusicFamiliarity: '',
            indianMusicGenres: [],
            hindustaniTraining: '',
            hindustaniYears: '',
            musicianType: '',
            musicalTrainingYears: '',
            musicalTrainingType: '',
            nationality: '',
            ethnicity: '',
            age: '',
            hindustaniFamiliarityAnswers: [],
            hindustaniFamiliarityScore: 0
        };
        
        let familiarityQuestionIndex = 0;
        const familiarityQuestions = [
            {
                question: "1. Which is the oldest form among these:",
                options: ["a) dhrupad", "b) khayal", "c) thumri"],
                correct: "a"
            },
            {
                question: "2. Which raga among these is typically performed during morning:",
                options: ["a) Bhimpalasi", "b) Bihag", "c) Bhairav"],
                correct: "c"
            },
            {
                question: "3. In a vocal khayal performance, which among these would be performed last:",
                options: ["a) drut composition", "b) vilambit composition", "c) alaap"],
                correct: "a"
            },
            {
                question: "4. Identify the scholar who is credited with classifying ragas into ten thaats:",
                options: ["a) Shrikrishna Narayan Ratanjankar", "b) Vishnu Narayan Bhatkhande", "c) Sourindro Mohun Tagore"],
                correct: "b"
            },
            {
                question: "5. Spot the percussion instrument most commonly used in dhrupad recitals:",
                options: ["a) tabla", "b) srikhol", "c) pakhavaj"],
                correct: "c"
            },
            {
                question: "6. Identify the pentatonic raga amongst them:",
                options: ["a) Bilawal", "b) Kedar", "c) Megh"],
                correct: "c"
            },
            {
                question: "7. Who amongst them happened to be a well-known composer of thumri:",
                options: ["a) Muhammad Shah 'Rangeela'", "b) Nawab Wajid Ali Shah", "c) Miyan Tansen"],
                correct: "b"
            },
            {
                question: "8. How many mantras are there in ektal:",
                options: ["a) 8", "b) 12", "c) 6"],
                correct: "b"
            }
        ];
        
        // Generate trials
        function generateTrials() {
            let trials = [];
            
            for (let rep = 0; rep < CONFIG.REPETITIONS; rep++) {
                for (let rhythm of CONFIG.RHYTHMS) {
                    trials.push({
                        rhythm: rhythm,
                        repetition: rep + 1,
                        trial_id: `${rhythm.name}_${rep + 1}`
                    });
                }
            }
            
            for (let i = trials.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [trials[i], trials[j]] = [trials[j], trials[i]];
            }
            
            trials.forEach((trial, index) => {
                trial.trial_number = index + 1;
            });
            
            return trials;
        }
        
        // Consent and survey functions
        function showConsentForm() {
            const content = `
                <h1>Study Information</h1>
                <div class="subtitle">Rhythm Alignment to Indian Rhythms. A Cross-Cultural Comparison</div>
                
                <div class="info-box" style="text-align: left; margin: 30px 0;">
                    <p><strong>Researchers:</strong> Miss Nashra Ahmad, Dr Martin Clayton, Dr Tuomas Eerola</p>
                    <p><strong>Contact email:</strong> nashra.ahmad@durham.ac.uk</p>
                    <br>
                    
                    <p>The experiment should take 8 minutes of your time. You may discontinue and quit the experiment anytime if you wish to. Please ensure you are in a comfortable environment and can listen to the sounds clearly.</p>
                    
                    <h3>What is this study about?</h3>
                    <p>In this study, you'll be matching tones to Indian rhythmic patterns by choosing where you feel the rhythm cycle begins. There are no right or wrong answers; we are simply interested in how you hear and experience rhythms. At the end, you'll get to see your results. This project is part of a PhD exploring how people from different cultural backgrounds perceive rhythm.</p>
                    
                    <h3>What will this study involve?</h3>
                    <p>The study will take place entirely online. You'll listen to two sounds: one is the rhythm, and the other is tones. Your task is to align the tones with the rhythm according to where you feel the rhythm cycle begins.</p>
                    
                    <h3>Will the data be used and stored?</h3>
                    <p>The data will be used for the PhD thesis of the researcher (Nashra Ahmad). The results from the data will be presented at conferences and potentially published in journals. The analysis will be completely anonymized, and your name will not be reported anywhere. The data will be securely stored in a password-protected online drive, shared only among the researchers.</p>
                    
                    <h3>What if you change your mind about your participation?</h3>
                    <p>You can withdraw your participation anytime while doing the experiment. Incomplete data will be discarded and deleted. As the data is not linked to your name or identity, you will not be able to withdraw your data after participation, as the researchers can no longer identify which data set is yours.</p>
                    
                    <h3>Who can you contact if you have questions or concerns?</h3>
                    <p>You can contact the PhD candidate and experimenter Nashra Ahmad (nashra.ahmad@durham.ac.uk) for any further questions.</p>
                    
                    <h3>Consent Statements:</h3>
                    <ul>
                        <li>I confirm that I have read and understand the above information about the project</li>
                        <li>I understand that my participation is voluntary and that I am free to withdraw at any time without giving any reason</li>
                        <li>I agree to take part in the above project</li>
                        <li>I have been informed about how the data will be used and stored</li>
                    </ul>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="handleConsent(true)">I consent: Begin Experiment</button>
                    <button class="btn" onclick="handleConsent(false)" style="background: #e53e3e;">I do not consent: End Experiment</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function handleConsent(consented) {
            if (consented) {
                showBackgroundQuestionnaire();
            } else {
                const content = `
                    <div class="info-box">
                        <h3>Thank you for your time</h3>
                        <p>You have chosen not to participate in this study. You may now close this window.</p>
                    </div>
                `;
                document.getElementById('experiment-content').innerHTML = content;
                updateStatus('Experiment ended - consent not given', '');
            }
        }
        
        function showBackgroundQuestionnaire() {
            const content = `
                <h2>Background Questionnaire</h2>
                <div class="subtitle">Please answer a few questions about your musical background</div>
                
                <div class="info-box" style="text-align: left;">
                    <h3>Musical Background</h3>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                            Are you familiar with Indian music of any form?
                        </label>
                        <label style="display: block; margin: 8px 0;">
                            <input type="radio" name="indianFamiliarity" value="yes" onchange="toggleIndianMusicQuestions(true)"> Yes
                        </label>
                        <label style="display: block; margin: 8px 0;">
                            <input type="radio" name="indianFamiliarity" value="no" onchange="toggleIndianMusicQuestions(false)"> No
                        </label>
                    </div>
                    
                    <div id="indian-music-questions" style="display: none; margin: 25px 0; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 10px;">
                        <div style="margin: 20px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Which genres of Indian music do you listen to? (Select all that apply)
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="hindustani-classical" onchange="updateIndianGenres()"> Hindustani Classical
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="carnatic-classical" onchange="updateIndianGenres()"> Carnatic Classical
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="sufi" onchange="updateIndianGenres()"> Sufi Music
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="bollywood-pop" onchange="updateIndianGenres()"> Bollywood Pop
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="indian-indie" onchange="updateIndianGenres()"> Indian-Indie
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="indian-rock" onchange="updateIndianGenres()"> Indian-Rock
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="punjabi" onchange="updateIndianGenres()"> Punjabi Music
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="indian-rap" onchange="updateIndianGenres()"> Indian-Rap
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="folk" onchange="updateIndianGenres()"> Folk Music
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="other-regional" onchange="updateIndianGenres()"> Other Regional Music
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="other" onchange="updateIndianGenres()"> Other Music
                            </label>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Are you trained in Hindustani Classical Music?
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="radio" name="hindustaniTraining" value="yes" onchange="toggleHindustaniYears(true)"> Yes
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="radio" name="hindustaniTraining" value="little" onchange="toggleHindustaniYears(true)"> A little
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="radio" name="hindustaniTraining" value="no" onchange="toggleHindustaniYears(false)"> No
                            </label>
                        </div>
                        
                        <div id="hindustani-years" style="display: none; margin: 20px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                How many years of training in Hindustani music do you have?
                            </label>
                            <input type="number" id="hindustani-years-input" placeholder="Years" min="0" max="50" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px;">
                        </div>
                        
                        <div id="hindustani-familiarity-scale" style="display: none; margin: 25px 0; padding: 20px; background: rgba(159, 122, 234, 0.05); border-radius: 10px; border: 2px solid #9f7aea;">
                            <h4 style="color: #2d3748; margin-bottom: 15px;">Hindustani Music Knowledge Assessment</h4>
                            <p style="color: #4a5568; margin-bottom: 20px; font-size: 0.9em;">Please answer the following questions. You'll get feedback after each answer.</p>
                            
                            <div id="familiarity-question-container">
                                <!-- Individual questions will be shown here -->
                            </div>
                        </div>
                        
                        <div id="general-music-questions" style="display: none; margin: 25px 0; padding: 20px; background: rgba(159, 122, 234, 0.05); border-radius: 10px;">
                            <div style="margin: 20px 0;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                    Which title best describes you?
                                </label>
                                <select id="musician-type" onchange="toggleMusicTrainingQuestions()" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                                    <option value="">Please select...</option>
                                    <option value="nonmusician">Nonmusician</option>
                                    <option value="music-loving">Music-loving nonmusician</option>
                                    <option value="amateur">Amateur musician</option>
                                    <option value="serious-amateur">Serious amateur musician</option>
                                    <option value="semiprofessional">Semiprofessional musician</option>
                                    <option value="professional">Professional musician</option>
                                </select>
                            </div>
                            
                            <div id="music-training-details" style="display: none; margin: 25px 0; padding: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 8px;">
                                <div style="margin: 20px 0;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                        How many years of musical training do you have?
                                    </label>
                                    <input type="number" id="training-years-input" placeholder="Years" min="0" max="100" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                                </div>
                                
                                <div style="margin: 20px 0;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                        What is your musical training/practice in?
                                    </label>
                                    <input type="text" id="musical-training-type" placeholder="e.g., piano, guitar, vocal, etc." style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="general-music-questions-main" style="display: none; margin: 25px 0; padding: 20px; background: rgba(159, 122, 234, 0.05); border-radius: 10px;">
                        <div style="margin: 20px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Which title best describes you?
                            </label>
                            <select id="musician-type-main" onchange="toggleMusicTrainingQuestionsMain()" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                                <option value="">Please select...</option>
                                <option value="nonmusician">Nonmusician</option>
                                <option value="music-loving">Music-loving nonmusician</option>
                                <option value="amateur">Amateur musician</option>
                                <option value="serious-amateur">Serious amateur musician</option>
                                <option value="semiprofessional">Semiprofessional musician</option>
                                <option value="professional">Professional musician</option>
                            </select>
                        </div>
                        
                        <div id="music-training-details-main" style="display: none; margin: 25px 0; padding: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 8px;">
                            <div style="margin: 20px 0;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                    How many years of musical training do you have?
                                </label>
                                <input type="number" id="training-years-input-main" placeholder="Years" min="0" max="100" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                    What is your musical training/practice in?
                                </label>
                                <input type="text" id="musical-training-type-main" placeholder="e.g., piano, guitar, vocal, etc." style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Demographics</h3>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                            What country is your nationality from?
                        </label>
                        <select id="nationality" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                            <option value="">Please select...</option>
                            <option value="Afghanistan">Afghanistan</option>
                            <option value="Albania">Albania</option>
                            <option value="Algeria">Algeria</option>
                            <option value="Argentina">Argentina</option>
                            <option value="Armenia">Armenia</option>
                            <option value="Australia">Australia</option>
                            <option value="Austria">Austria</option>
                            <option value="Azerbaijan">Azerbaijan</option>
                            <option value="Bahrain">Bahrain</option>
                            <option value="Bangladesh">Bangladesh</option>
                            <option value="Belarus">Belarus</option>
                            <option value="Belgium">Belgium</option>
                            <option value="Bolivia">Bolivia</option>
                            <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                            <option value="Brazil">Brazil</option>
                            <option value="Bulgaria">Bulgaria</option>
                            <option value="Cambodia">Cambodia</option>
                            <option value="Canada">Canada</option>
                            <option value="Chile">Chile</option>
                            <option value="China">China</option>
                            <option value="Colombia">Colombia</option>
                            <option value="Croatia">Croatia</option>
                            <option value="Czech Republic">Czech Republic</option>
                            <option value="Denmark">Denmark</option>
                            <option value="Ecuador">Ecuador</option>
                            <option value="Egypt">Egypt</option>
                            <option value="Estonia">Estonia</option>
                            <option value="Ethiopia">Ethiopia</option>
                            <option value="Finland">Finland</option>
                            <option value="France">France</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Germany">Germany</option>
                            <option value="Ghana">Ghana</option>
                            <option value="Greece">Greece</option>
                            <option value="Hungary">Hungary</option>
                            <option value="Iceland">Iceland</option>
                            <option value="India">India</option>
                            <option value="Indonesia">Indonesia</option>
                            <option value="Iran">Iran</option>
                            <option value="Iraq">Iraq</option>
                            <option value="Ireland">Ireland</option>
                            <option value="Israel">Israel</option>
                            <option value="Italy">Italy</option>
                            <option value="Japan">Japan</option>
                            <option value="Jordan">Jordan</option>
                            <option value="Kazakhstan">Kazakhstan</option>
                            <option value="Kenya">Kenya</option>
                            <option value="Kuwait">Kuwait</option>
                            <option value="Latvia">Latvia</option>
                            <option value="Lebanon">Lebanon</option>
                            <option value="Lithuania">Lithuania</option>
                            <option value="Luxembourg">Luxembourg</option>
                            <option value="Malaysia">Malaysia</option>
                            <option value="Mexico">Mexico</option>
                            <option value="Morocco">Morocco</option>
                            <option value="Nepal">Nepal</option>
                            <option value="Netherlands">Netherlands</option>
                            <option value="New Zealand">New Zealand</option>
                            <option value="Nigeria">Nigeria</option>
                            <option value="Norway">Norway</option>
                            <option value="Pakistan">Pakistan</option>
                            <option value="Peru">Peru</option>
                            <option value="Philippines">Philippines</option>
                            <option value="Poland">Poland</option>
                            <option value="Portugal">Portugal</option>
                            <option value="Qatar">Qatar</option>
                            <option value="Romania">Romania</option>
                            <option value="Russia">Russia</option>
                            <option value="Saudi Arabia">Saudi Arabia</option>
                            <option value="Serbia">Serbia</option>
                            <option value="Singapore">Singapore</option>
                            <option value="Slovakia">Slovakia</option>
                            <option value="Slovenia">Slovenia</option>
                            <option value="South Africa">South Africa</option>
                            <option value="South Korea">South Korea</option>
                            <option value="Spain">Spain</option>
                            <option value="Sri Lanka">Sri Lanka</option>
                            <option value="Sweden">Sweden</option>
                            <option value="Switzerland">Switzerland</option>
                            <option value="Thailand">Thailand</option>
                            <option value="Turkey">Turkey</option>
                            <option value="Ukraine">Ukraine</option>
                            <option value="United Arab Emirates">United Arab Emirates</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="United States">United States</option>
                            <option value="Uruguay">Uruguay</option>
                            <option value="Venezuela">Venezuela</option>
                            <option value="Vietnam">Vietnam</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                            What is your ethnicity? (UK Census 2021 categories)
                        </label>
                        <select id="ethnicity" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                            <option value="">Please select...</option>
                            
                            <optgroup label="Asian or Asian British">
                                <option value="Indian">Indian</option>
                                <option value="Pakistani">Pakistani</option>
                                <option value="Bangladeshi">Bangladeshi</option>
                                <option value="Chinese">Chinese</option>
                                <option value="Any other Asian background">Any other Asian background</option>
                            </optgroup>
                            
                            <optgroup label="Black, Black British, Caribbean or African">
                                <option value="Caribbean">Caribbean</option>
                                <option value="African">African</option>
                                <option value="Any other Black, Black British, or Caribbean background">Any other Black, Black British, or Caribbean background</option>
                            </optgroup>
                            
                            <optgroup label="Mixed or multiple ethnic groups">
                                <option value="White and Black Caribbean">White and Black Caribbean</option>
                                <option value="White and Black African">White and Black African</option>
                                <option value="White and Asian">White and Asian</option>
                                <option value="Any other Mixed or multiple ethnic background">Any other Mixed or multiple ethnic background</option>
                            </optgroup>
                            
                            <optgroup label="White">
                                <option value="English, Welsh, Scottish, Northern Irish or British">English, Welsh, Scottish, Northern Irish or British</option>
                                <option value="Irish">Irish</option>
                                <option value="Gypsy or Irish Traveller">Gypsy or Irish Traveller</option>
                                <option value="Roma">Roma</option>
                                <option value="Any other White background">Any other White background</option>
                            </optgroup>
                            
                            <optgroup label="Other ethnic group">
                                <option value="Arab">Arab</option>
                                <option value="Any other ethnic group">Any other ethnic group</option>
                            </optgroup>
                            
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                            Age
                        </label>
                        <input type="number" id="age" placeholder="Your age" min="1" max="120" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; width: 100%;">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="submitBackgroundQuestionnaire()">Continue to Instructions</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function toggleIndianMusicQuestions(show) {
            document.getElementById('indian-music-questions').style.display = show ? 'block' : 'none';
            document.getElementById('general-music-questions-main').style.display = show ? 'none' : 'block';
            surveyData.indianMusicFamiliarity = show ? 'yes' : 'no';
        }
        
        function toggleHindustaniYears(show) {
            document.getElementById('hindustani-years').style.display = show ? 'block' : 'none';
            
            if (show) {
                document.getElementById('hindustani-familiarity-scale').style.display = 'block';
                document.getElementById('general-music-questions').style.display = 'none';
                familiarityQuestionIndex = 0;
                surveyData.hindustaniFamiliarityAnswers = [];
                surveyData.hindustaniFamiliarityScore = 0;
                showFamiliarityQuestion();
            } else {
                document.getElementById('hindustani-familiarity-scale').style.display = 'none';
                document.getElementById('general-music-questions').style.display = 'block';
            }
        }
        
        function toggleMusicTrainingQuestions() {
            const musicianType = document.getElementById('musician-type').value;
            const trainingDetails = document.getElementById('music-training-details');
            
            const needsTrainingQuestions = ['amateur', 'serious-amateur', 'semiprofessional', 'professional'].includes(musicianType);
            trainingDetails.style.display = needsTrainingQuestions ? 'block' : 'none';
        }
        
        function toggleMusicTrainingQuestionsMain() {
            const musicianType = document.getElementById('musician-type-main').value;
            const trainingDetails = document.getElementById('music-training-details-main');
            
            const needsTrainingQuestions = ['amateur', 'serious-amateur', 'semiprofessional', 'professional'].includes(musicianType);
            trainingDetails.style.display = needsTrainingQuestions ? 'block' : 'none';
        }
        
        function updateIndianGenres() {
            const checkboxes = document.querySelectorAll('#indian-music-questions input[type="checkbox"]:checked');
            surveyData.indianMusicGenres = Array.from(checkboxes).map(cb => cb.value);
        }
        
        function showFamiliarityQuestion() {
            if (familiarityQuestionIndex >= familiarityQuestions.length) {
                showFamiliarityResults();
                return;
            }
            
            const question = familiarityQuestions[familiarityQuestionIndex];
            const container = document.getElementById('familiarity-question-container');
            
            container.innerHTML = `
                <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px;">
                    <p style="font-weight: bold; margin-bottom: 15px;">${question.question}</p>
                    ${question.options.map((option, index) => `
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="radio" name="current-familiarity-q" value="${String.fromCharCode(97 + index)}" 
                                   onchange="handleFamiliarityAnswer('${String.fromCharCode(97 + index)}')" 
                                   style="margin-right: 8px;"> ${option}
                        </label>
                    `).join('')}
                    
                    <div id="question-feedback" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                        <!-- Feedback will appear here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <div style="color: #718096; font-size: 0.9em;">Question ${familiarityQuestionIndex + 1} of ${familiarityQuestions.length}</div>
                    </div>
                </div>
            `;
        }
        
        function handleFamiliarityAnswer(selectedAnswer) {
            const question = familiarityQuestions[familiarityQuestionIndex];
            const isCorrect = selectedAnswer === question.correct;
            
            surveyData.hindustaniFamiliarityAnswers.push(selectedAnswer);
            if (isCorrect) {
                surveyData.hindustaniFamiliarityScore++;
            }
            
            const feedbackDiv = document.getElementById('question-feedback');
            feedbackDiv.style.display = 'block';
            
            if (isCorrect) {
                feedbackDiv.style.background = 'rgba(72, 187, 120, 0.1)';
                feedbackDiv.style.border = '1px solid #48bb78';
                feedbackDiv.style.color = '#2f855a';
                feedbackDiv.innerHTML = `<strong>✓ Correct!</strong>`;
            } else {
                feedbackDiv.style.background = 'rgba(229, 62, 62, 0.1)';
                feedbackDiv.style.border = '1px solid #e53e3e';
                feedbackDiv.style.color = '#c53030';
                feedbackDiv.innerHTML = `<strong>✗ Incorrect.</strong> The correct answer is <strong>${question.correct})</strong>.`;
            }
            
            const radioButtons = document.querySelectorAll('input[name="current-familiarity-q"]');
            radioButtons.forEach(radio => radio.disabled = true);
            
            const continueButton = document.createElement('button');
            continueButton.textContent = familiarityQuestionIndex === familiarityQuestions.length - 1 ? 'Show Results' : 'Next Question';
            continueButton.className = 'btn btn-primary';
            continueButton.style.marginTop = '15px';
            continueButton.onclick = () => {
                familiarityQuestionIndex++;
                showFamiliarityQuestion();
            };
            feedbackDiv.appendChild(continueButton);
        }
        
        function showFamiliarityResults() {
            const container = document.getElementById('familiarity-question-container');
            const percentage = Math.round((surveyData.hindustaniFamiliarityScore / familiarityQuestions.length) * 100);
            
            container.innerHTML = `
                <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 8px; text-align: center;">
                    <h4 style="color: #2d3748; margin-bottom: 15px;">Assessment Complete!</h4>
                    <div style="font-size: 2em; font-weight: bold; color: #667eea; margin: 15px 0;">
                        ${surveyData.hindustaniFamiliarityScore} / ${familiarityQuestions.length}
                    </div>
                    <div style="font-size: 1.1em; color: #4a5568; margin-bottom: 15px;">
                        ${percentage}% correct
                    </div>
                    <div style="color: #718096; font-size: 0.9em;">
                        This assessment helps us understand your level of Hindustani music knowledge.
                    </div>
                </div>
            `;
        }
        
        function submitBackgroundQuestionnaire() {
            surveyData.nationality = document.getElementById('nationality')?.value || '';
            surveyData.ethnicity = document.getElementById('ethnicity')?.value || '';
            surveyData.age = document.getElementById('age')?.value || '';
            
            if (surveyData.indianMusicFamiliarity === 'yes') {
                const hindustaniRadio = document.querySelector('input[name="hindustaniTraining"]:checked');
                surveyData.hindustaniTraining = hindustaniRadio?.value || '';
                surveyData.hindustaniYears = document.getElementById('hindustani-years-input')?.value || '';
                
                // If they said "No" to Hindustani training, collect general music info
                if (surveyData.hindustaniTraining === 'no') {
                    surveyData.musicianType = document.getElementById('musician-type')?.value || '';
                    
                    const needsTrainingQuestions = ['amateur', 'serious-amateur', 'semiprofessional', 'professional'].includes(surveyData.musicianType);
                    if (needsTrainingQuestions) {
                        surveyData.musicalTrainingYears = document.getElementById('training-years-input')?.value || '';
                        surveyData.musicalTrainingType = document.getElementById('musical-training-type')?.value || '';
                    }
                }
            } else {
                // They said "No" to Indian music familiarity
                surveyData.musicianType = document.getElementById('musician-type-main')?.value || '';
                
                const needsTrainingQuestions = ['amateur', 'serious-amateur', 'semiprofessional', 'professional'].includes(surveyData.musicianType);
                if (needsTrainingQuestions) {
                    surveyData.musicalTrainingYears = document.getElementById('training-years-input-main')?.value || '';
                    surveyData.musicalTrainingType = document.getElementById('musical-training-type-main')?.value || '';
                }
            }
            
            if (!surveyData.age) {
                updateStatus('Please enter your age to continue', 'warning');
                return;
            }
            
            if (!surveyData.nationality) {
                updateStatus('Please select your nationality to continue', 'warning');
                return;
            }
            
            if (!surveyData.ethnicity) {
                updateStatus('Please select your ethnicity to continue', 'warning');
                return;
            }
            
            participantAge = surveyData.age;
            showExamplePage();
        }
        
        function showExamplePage() {
            const content = `
                <h2>Listen to the Example</h2>
                <div class="subtitle">Understanding the Alignment Task</div>
                
                <div class="instructions">
                    <h3>Example Audio</h3>
                    <p style="font-size: 1.1em; margin-bottom: 20px; font-weight: 500; color: #2d3748;">
                        First, listen to how the tone (beep) is aligned with the drum pattern:
                    </p>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" id="example-play-btn" onclick="playExampleAudio()" style="font-size: 1.2em; padding: 18px 35px;">▶ Play Example</button>
                        <button class="btn" id="example-stop-btn" onclick="stopExampleAudio()" style="font-size: 1.2em; padding: 18px 35px;">⏹ Stop</button>
                    </div>
                    
                    <div id="example-status" class="status" style="display: none;">
                        <!-- Status will appear here -->
                    </div>
                    
                    <div style="margin: 30px 0; padding: 25px; background: rgba(66, 153, 225, 0.05); border-radius: 10px; border-left: 4px solid #4299e1;">
                        <p style="color: #4a5568; line-height: 1.6; margin-bottom: 15px; font-size: 1.05em;">
                            In this example, you can hear how the tones (beeps) are perfectly aligned with the drum pattern. 
                            This demonstrates the kind of alignment you'll be working to achieve in the actual experiment.
                        </p>
                        <p style="color: #4a5568; line-height: 1.6; font-weight: 500;">
                            Listen as many times as you need to understand how the sounds work together.
                        </p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-next" onclick="showInstructions()">Continue to Practice</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            
            // Load the example audio
            loadExampleAudio();
        }
        
        function showInstructions() {
            // FIX #1: Stop example audio when proceeding to practice
            stopExampleAudio();
            
            const content = `
                <h2>Instructions and Practice</h2>
                <div class="subtitle">Learn the Controls</div>
                
                <div class="instructions">
                    <div style="margin: 25px 0; padding: 20px; background: rgba(66, 153, 225, 0.05); border-radius: 10px; border-left: 4px solid #4299e1;">
                        <h4 style="color: #2d3748; margin-bottom: 15px;">Your Task:</h4>
                        <p style="color: #4a5568; line-height: 1.6; margin-bottom: 10px;">
                            You'll hear a rhythmic cycle with misaligned tones (beeps). Align the tones with where you think the cycle begins.
                        </p>
                        <p style="color: #4a5568; line-height: 1.6;">
                            Use ← → arrow keys or buttons below to move the tones. The wheel shows your current adjustment.
                        </p>
                    </div>
                </div>
                
                <div style="text-align: center; color: #718096; font-size: 0.9em; margin: 5px 0 3px 0; font-weight: 500;">Practice 1</div>
                
                <div class="control-panel">
                    <div class="beat-display">
                        <div style="color: #718096; font-size: 0.9em;">Practice aligning the tones. Use the arrows to adjust timing.</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="playPracticeAudio()" style="font-size: 1.2em; padding: 18px 35px;">▶ Play</button>
                        <button class="btn" onclick="pauseAudio()" style="font-size: 1.2em; padding: 18px 35px;">⏸ Pause</button>
                    </div>
                    
                    <div class="beat-controls">
                        <button class="beat-btn" onclick="adjustPracticeBeat(1)" title="Shift tones earlier">←</button>
                        <div style="text-align: center; color: #4a5568;">
                            <div style="font-weight: bold; font-size: 1.1em;">Timing Control</div>
                            <div style="font-size: 0.9em; margin-top: 5px;">← Earlier | Later →</div>
                        </div>
                        <button class="beat-btn" onclick="adjustPracticeBeat(-1)" title="Shift tones later">→</button>
                    </div>
                    
                    <div class="wheel-container">
                        <div class="wheel-label">Visual Indicator</div>
                        <div class="timing-wheel" id="timing-wheel">
                            <div class="wheel-base">
                                ${generateWheelTicks(CONFIG.PRACTICE.practice1.beats_per_cycle)}
                                <div class="wheel-pointer" id="wheel-pointer"></div>
                                <div class="wheel-center"></div>
                            </div>
                        </div>
                        <div class="wheel-labels">
                            Shows current timing adjustment
                        </div>
                    </div>
                    
                    <div id="practice-feedback" style="margin: 8px 0 5px 0; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; text-align: center; font-weight: 500;">
                        <div style="color: #4a5568; margin-bottom: 6px;">Current alignment:</div>
                        <div id="beat-position-display" style="font-size: 1.2em; font-weight: bold; color: #667eea;">Beat 1 (Start of cycle)</div>
                        <div style="color: #718096; font-size: 0.85em; margin-top: 6px;">Use arrows to adjust • Goal: Align tones to where the cycle begins (Beat 1)</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-next" onclick="finishPractice1()">Continue to Practice 2</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            
            // Load both example and practice audio
            loadAndStartPractice1();
        }
        
        async function loadAndStartPractice1() {
            currentPractice = CONFIG.PRACTICE.practice1;
            await loadPracticeAudio(currentPractice);
            initializePractice();
            updateWheelVisualization();
            updatePracticeFeedback();
        }
        
        // Audio functions
        async function initializeAudio() {
            try {
                console.log('Initializing audio context...');
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (audioContext.state === 'suspended') {
                    console.log('Audio context is suspended, will resume when needed');
                }
                
                gainNodes.rhythm = audioContext.createGain();
                gainNodes.tones = audioContext.createGain();
                
                gainNodes.rhythm.connect(audioContext.destination);
                gainNodes.tones.connect(audioContext.destination);
                
                gainNodes.rhythm.gain.value = 0.7;
                gainNodes.tones.gain.value = 0.8;
                
                console.log('Audio context initialized successfully');
                console.log('Sample rate:', audioContext.sampleRate);
                console.log('Audio context state:', audioContext.state);
                
                return true;
            } catch (error) {
                console.error('Audio initialization failed:', error);
                return false;
            }
        }
        
        async function loadAudioBuffer(url) {
            console.log('Loading audio from:', url);
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Could not load ${url}. Make sure the file exists and is accessible.`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                console.log('Successfully loaded and decoded:', url);
                return audioBuffer;
            } catch (error) {
                console.error('Error loading audio:', error);
                throw error;
            }
        }
        
        async function loadExampleAudio() {
            try {
                console.log('Attempting to load example audio from:', CONFIG.PRACTICE.example_audio);
                updateExampleStatus('Loading example audio...', 'warning');
                
                const buffer = await loadAudioBuffer(CONFIG.PRACTICE.example_audio);
                exampleAudioBuffer = buffer;
                updateExampleStatus('Example audio loaded successfully!', 'success');
                console.log('Example audio loaded successfully');
            } catch (error) {
                console.error('Failed to load example audio:', error);
                updateExampleStatus('⚠️ Audio file not found. Please check that audio files are in the correct folder.', 'error');
                
                // Show helpful message to user
                const helpMessage = `
                    <div style="background: rgba(229, 62, 62, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #e53e3e;">
                        <strong>Audio Loading Error:</strong><br>
                        The audio file '${CONFIG.PRACTICE.example_audio}' could not be loaded.<br><br>
                        <strong>Please ensure:</strong><br>
                        • Audio files are in an 'audio/' folder<br>
                        • The file 'Drum_Example.mp3' exists<br>
                        • You're running the experiment from a web server (not file://)
                    </div>
                `;
                
                const container = document.querySelector('.instructions');
                if (container) {
                    container.innerHTML += helpMessage;
                }
            }
        }
        
        async function playExampleAudio() {
            if (!exampleAudioBuffer) {
                updateExampleStatus('Example audio not loaded', 'error');
                return;
            }
            
            try {
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                // Stop any currently playing example audio
                stopExampleAudio();
                
                exampleAudioSource = audioContext.createBufferSource();
                exampleAudioSource.buffer = exampleAudioBuffer;
                exampleAudioSource.connect(audioContext.destination);
                exampleAudioSource.start();
                
                isExamplePlaying = true;
                updateExampleStatus('Playing example audio...', 'success');
                
                // Auto-stop when finished
                exampleAudioSource.onended = () => {
                    isExamplePlaying = false;
                    updateExampleStatus('Example complete. Continue to Practice 1 below.', '');
                    exampleAudioSource = null;
                };
                
            } catch (error) {
                console.error('Example audio playback error:', error);
                updateExampleStatus('Failed to play example audio', 'error');
            }
        }
        
        function stopExampleAudio() {
            if (exampleAudioSource) {
                try {
                    exampleAudioSource.stop();
                } catch(e) {
                    // Ignore errors if already stopped
                }
                exampleAudioSource = null;
            }
            isExamplePlaying = false;
            updateExampleStatus('Example stopped.', '');
        }
        
        function updateExampleStatus(message, type = '') {
            const statusEl = document.getElementById('example-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
                statusEl.style.display = message ? 'block' : 'none';
            }
        }
        
        async function smoothRestartPracticeAudio() {
            if (!audioBuffers.rhythm || !audioBuffers.tones || !isPlaying) {
                return;
            }
            
            try {
                // Create fade-out for current audio
                const fadeOutDuration = 0.05; // 50ms crossfade
                const now = audioContext.currentTime;
                
                // Fade out current sources
                if (gainNodes.rhythm && gainNodes.tones) {
                    gainNodes.rhythm.gain.linearRampToValueAtTime(0, now + fadeOutDuration);
                    gainNodes.tones.gain.linearRampToValueAtTime(0, now + fadeOutDuration);
                }
                
                // Schedule new audio to start with fade-in
                setTimeout(async () => {
                    if (!isPlaying) return; // Check if still playing
                    
                    // Stop old sources
                    Object.values(audioSources).forEach(source => {
                        if (source) {
                            try { source.stop(); } catch(e) {}
                        }
                    });
                    
                    // Start new audio with current timing
                    const restartNow = audioContext.currentTime + 0.01;
                    const toneOffset = currentBeatOffset * currentPractice.beat_duration;
                    
                    audioSources.rhythm = audioContext.createBufferSource();
                    audioSources.rhythm.buffer = audioBuffers.rhythm;
                    audioSources.rhythm.connect(gainNodes.rhythm);
                    audioSources.rhythm.start(restartNow, currentPlaybackPosition);
                    
                    audioSources.tones = audioContext.createBufferSource();
                    audioSources.tones.buffer = audioBuffers.tones;
                    audioSources.tones.connect(gainNodes.tones);
                    audioSources.tones.start(restartNow, currentPlaybackPosition + toneOffset);
                    
                    // Fade in new audio
                    gainNodes.rhythm.gain.setValueAtTime(0, restartNow);
                    gainNodes.rhythm.gain.linearRampToValueAtTime(0.7, restartNow + fadeOutDuration);
                    
                    gainNodes.tones.gain.setValueAtTime(0, restartNow);
                    gainNodes.tones.gain.linearRampToValueAtTime(0.8, restartNow + fadeOutDuration);
                    
                    playbackStartTime = restartNow;
                    
                    // Handle audio end
                    const remainingDuration = audioBuffers.rhythm.duration - currentPlaybackPosition;
                    setTimeout(() => {
                        if (isPlaying) {
                            currentPlaybackPosition = 0;
                            isFirstPlay = true;
                            stopAudio();
                            updateStatus('Practice audio finished. Click Play to listen again.', '');
                        }
                    }, remainingDuration * 1000);
                    
                }, fadeOutDuration * 1000);
                
            } catch (error) {
                console.error('Smooth restart failed:', error);
                // Fallback to regular restart
                playPracticeAudio();
            }
        }
        
        async function smoothRestartAudio() {
            if (!audioBuffers.rhythm || !audioBuffers.tones || !isPlaying) {
                return;
            }
            
            try {
                console.log('Real-time audio adjustment during trial');
                
                // Calculate current playback position
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                
                // Ensure we don't go beyond buffer duration
                if (currentPlaybackPosition >= audioBuffers.rhythm.duration) {
                    currentPlaybackPosition = 0;
                    isFirstPlay = true;
                }
                
                // Very short crossfade for real-time responsiveness
                const now = audioContext.currentTime;
                const restartDelay = 0.02; // 20ms - minimal but perceptible delay
                const restartTime = now + restartDelay;
                const newToneOffset = currentBeatOffset * currentTrial.rhythm.beat_duration;
                
                // Quickly fade out current audio
                if (gainNodes.rhythm && gainNodes.tones) {
                    gainNodes.rhythm.gain.linearRampToValueAtTime(0, restartTime);
                    gainNodes.tones.gain.linearRampToValueAtTime(0, restartTime);
                }
                
                // Stop old sources at restart time
                setTimeout(() => {
                    Object.values(audioSources).forEach(source => {
                        if (source) {
                            try { source.stop(); } catch(e) {}
                        }
                    });
                    
                    // Immediately start new audio with updated timing
                    audioSources.rhythm = audioContext.createBufferSource();
                    audioSources.rhythm.buffer = audioBuffers.rhythm;
                    audioSources.rhythm.connect(gainNodes.rhythm);
                    
                    audioSources.tones = audioContext.createBufferSource();
                    audioSources.tones.buffer = audioBuffers.tones;
                    audioSources.tones.connect(gainNodes.tones);
                    
                    // Start with new timing - REAL-TIME ALIGNMENT
                    audioSources.rhythm.start(restartTime, currentPlaybackPosition);
                    audioSources.tones.start(restartTime, currentPlaybackPosition + newToneOffset);
                    
                    // Restore proper gain levels based on experimental design
                    const firstCycleDuration = currentTrial.rhythm.beats_per_cycle * currentTrial.rhythm.beat_duration;
                    const shouldFadeIn = currentPlaybackPosition < firstCycleDuration;
                    
                    if (shouldFadeIn) {
                        // Continue fade-in from current position
                        const remainingFadeTime = Math.max(0.1, firstCycleDuration - currentPlaybackPosition);
                        const currentFadeProgress = 1 - (remainingFadeTime / firstCycleDuration);
                        const currentGainLevel = 0.05 + (0.65 * currentFadeProgress); // Calculate current fade level
                        
                        gainNodes.rhythm.gain.setValueAtTime(currentGainLevel, restartTime);
                        gainNodes.rhythm.gain.linearRampToValueAtTime(0.7, restartTime + remainingFadeTime);
                    } else {
                        // Second cycle or later - full volume immediately
                        gainNodes.rhythm.gain.setValueAtTime(0.7, restartTime);
                    }
                    
                    // Tones always at full volume for immediate timing feedback
                    gainNodes.tones.gain.setValueAtTime(0.8, restartTime);
                    
                    // Update timing tracking
                    playbackStartTime = restartTime;
                    
                    console.log(`Real-time adjustment: Beat offset ${currentBeatOffset}, Tone offset ${newToneOffset.toFixed(3)}s`);
                    
                }, restartDelay * 1000);
                
            } catch (error) {
                console.error('Real-time adjustment failed:', error);
                // Fallback to full restart
                await playAudio();
            }
        }
        
        function stopAudio() {
            // Clear any existing timeout to prevent unexpected stops
            if (window.audioTimeout) {
                clearTimeout(window.audioTimeout);
                window.audioTimeout = null;
            }
            
            Object.values(audioSources).forEach(source => {
                if (source) {
                    try { source.stop(); } catch(e) {}
                }
            });
            audioSources.rhythm = null;
            audioSources.tones = null;
            isPlaying = false;
        }
        
        // Practice functions
        async function startPractice() {
            practiceStage = 0;
            await showPracticeStage();
        }
        
        async function showPracticeStage() {
            if (practiceStage === 0) {
                await showPractice1();
            } else if (practiceStage === 1) {
                await showPractice2();
            } else {
                showExperimentInstructions();
            }
        }
        
        async function showPractice2() {
            currentPractice = CONFIG.PRACTICE.practice2;
            
            const content = `
                <div style="text-align: center; color: #718096; font-size: 0.9em; margin: 5px 0 3px 0; font-weight: 500;">Practice 2</div>
                
                <div class="control-panel">
                    <div class="beat-display">
                        <div style="color: #718096; font-size: 0.95em; margin-top: 8px;">Second practice round. Get comfortable with the controls before the main experiment.</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="playPracticeAudio()" style="font-size: 1.2em; padding: 18px 35px;">▶ Play</button>
                        <button class="btn" onclick="pauseAudio()" style="font-size: 1.2em; padding: 18px 35px;">⏸ Pause</button>
                    </div>
                    
                    <div class="beat-controls">
                        <button class="beat-btn" onclick="adjustPracticeBeat(1)" title="Shift tones earlier">←</button>
                        <div style="text-align: center; color: #4a5568;">
                            <div style="font-weight: bold; font-size: 1.1em;">Timing Control</div>
                            <div style="font-size: 0.9em; margin-top: 5px;">← Earlier | Later →</div>
                        </div>
                        <button class="beat-btn" onclick="adjustPracticeBeat(-1)" title="Shift tones later">→</button>
                    </div>
                    
                    <div class="wheel-container">
                        <div class="wheel-label">Visual Indicator</div>
                        <div class="timing-wheel" id="timing-wheel">
                            <div class="wheel-base">
                                ${generateWheelTicks(currentPractice.beats_per_cycle)}
                                <div class="wheel-pointer" id="wheel-pointer"></div>
                                <div class="wheel-center"></div>
                            </div>
                        </div>
                        <div class="wheel-labels">
                            Shows current timing adjustment
                        </div>
                    </div>
                    
                    <div id="practice-feedback" style="margin: 20px 0; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; text-align: center; font-weight: 500;">
                        <div style="color: #4a5568; margin-bottom: 8px;">Current alignment:</div>
                        <div id="beat-position-display" style="font-size: 1.3em; font-weight: bold; color: #667eea;">Beat 1 (Start of cycle)</div>
                        <div style="color: #718096; font-size: 0.9em; margin-top: 8px;">Use arrows to adjust • Goal: Align tones to where the cycle begins (Beat 1)</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-next" onclick="finishPractice2()">Ready for Main Experiment</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            
            await loadPracticeAudio(currentPractice);
            initializePractice();
            updateWheelVisualization();
        }
        
        async function loadPracticeAudio(practice) {
            try {
                updateStatus(`Loading ${practice.name} audio...`, 'warning');
                
                const [rhythmBuffer, tonesBuffer] = await Promise.all([
                    loadAudioBuffer(practice.stm1),
                    loadAudioBuffer(practice.stm2)
                ]);
                
                audioBuffers.rhythm = rhythmBuffer;
                audioBuffers.tones = tonesBuffer;
                
                updateStatus(`${practice.name} audio loaded!`, 'success');
                return true;
                
            } catch (error) {
                console.error(`Practice audio loading failed:`, error);
                updateStatus(`Failed to load ${practice.name} audio`, 'error');
                return false;
            }
        }
        
        function initializePractice() {
            initialBeatOffset = Math.floor(Math.random() * (currentPractice.beats_per_cycle - 1)) + 1;
            currentBeatOffset = initialBeatOffset;
            currentPlaybackPosition = 0;
            isFirstPlay = true;
            adjustmentCount = 0;
            
            // Always start blob at 12:00 position (0 degrees)
            cumulativeWheelAngle = 0;
        }
        
        async function playPracticeAudio() {
            if (!audioBuffers.rhythm || !audioBuffers.tones) {
                updateStatus('Practice audio not loaded', 'error');
                return false;
            }
            
            try {
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                // Always stop any existing audio first to prevent overlap
                stopAudio();
                
                const now = audioContext.currentTime + 0.1;
                const toneOffset = currentBeatOffset * currentPractice.beat_duration;
                
                let startPosition;
                if (isFirstPlay) {
                    const randomBeat = Math.floor(Math.random() * currentPractice.beats_per_cycle) + 1;
                    startPosition = (randomBeat - 1) * currentPractice.beat_duration;
                    currentPlaybackPosition = startPosition;
                    isFirstPlay = false;
                } else {
                    startPosition = currentPlaybackPosition;
                }
                
                // Ensure we don't start beyond the audio duration
                if (startPosition >= audioBuffers.rhythm.duration) {
                    startPosition = 0;
                    currentPlaybackPosition = 0;
                    isFirstPlay = true;
                }
                
                audioSources.rhythm = audioContext.createBufferSource();
                audioSources.rhythm.buffer = audioBuffers.rhythm;
                audioSources.rhythm.connect(gainNodes.rhythm);
                
                audioSources.tones = audioContext.createBufferSource();
                audioSources.tones.buffer = audioBuffers.tones;
                audioSources.tones.connect(gainNodes.tones);
                
                // Add error handlers to prevent unexpected stops
                audioSources.rhythm.onerror = (e) => {
                    console.error('Practice rhythm audio error:', e);
                    updateStatus('Practice rhythm audio error - click Play to restart', 'error');
                };
                
                audioSources.tones.onerror = (e) => {
                    console.error('Practice tones audio error:', e);
                    updateStatus('Practice tones audio error - click Play to restart', 'error');
                };
                
                // Start both audio sources
                audioSources.rhythm.start(now, startPosition);
                audioSources.tones.start(now, startPosition + toneOffset);
                
                gainNodes.rhythm.gain.setValueAtTime(0.7, now);
                gainNodes.tones.gain.setValueAtTime(0.8, now);
                
                isPlaying = true;
                playbackStartTime = now;
                
                updateStatus('Playing practice... Use arrows to adjust alignment', 'success');
                
                // Calculate remaining duration more accurately
                const remainingDuration = Math.max(0, audioBuffers.rhythm.duration - startPosition);
                
                // Clear any existing timeout
                if (window.audioTimeout) {
                    clearTimeout(window.audioTimeout);
                }
                
                // Set timeout with extra buffer to prevent premature stopping
                window.audioTimeout = setTimeout(() => {
                    if (isPlaying) {
                        console.log('Practice audio timeout reached, stopping playback');
                        currentPlaybackPosition = 0;
                        isFirstPlay = true;
                        stopAudio();
                        updateStatus('Practice audio finished. Click Play to listen again.', '');
                    }
                }, (remainingDuration + 0.5) * 1000); // Add 500ms buffer
                
                return true;
                
            } catch (error) {
                console.error('Practice audio playback error:', error);
                updateStatus('Practice audio playback failed', 'error');
                isPlaying = false;
                return false;
            }
        }
        
        function adjustPracticeBeat(direction) {
            let newOffset = currentBeatOffset + direction;
            
            if (newOffset >= currentPractice.beats_per_cycle) {
                newOffset = 0;
            } else if (newOffset < 0) {
                newOffset = currentPractice.beats_per_cycle - 1;
            }
            
            currentBeatOffset = newOffset;
            adjustmentCount++;
            
            // Calculate angle per beat for this specific rhythm
            const anglePerBeat = 360 / currentPractice.beats_per_cycle;
            
            // Move the blob continuously around the circle
            // Left arrow (direction 1) = counter-clockwise (subtract)
            // Right arrow (direction -1) = clockwise (add)
            cumulativeWheelAngle -= direction * anglePerBeat;
            
            updateWheelVisualization();
            updatePracticeFeedback();
            
            if (isPlaying) {
                // RESTORE ORIGINAL: Immediate real-time adjustment 
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                playPracticeAudio(); // Direct restart like original code
                updateStatus('Practice timing adjusted - audio continues', 'success');
            } else {
                updateStatus('Practice adjustment made. Click Play to hear the change.', '');
            }
        }
        
        function updatePracticeFeedback() {
            const display = document.getElementById('beat-position-display');
            if (!display) return;
            
            const beatNumber = currentBeatOffset + 1;
            const totalBeats = currentPractice.beats_per_cycle;
            
            let feedbackText = '';
            let feedbackColor = '';
            
            if (currentBeatOffset === 0) {
                feedbackText = `Beat 1 (Start of cycle) ✓`;
                feedbackColor = '#38a169'; // Green for correct
            } else {
                feedbackText = `Beat ${beatNumber} of ${totalBeats}`;
                feedbackColor = '#667eea'; // Blue for other positions
            }
            
            display.innerHTML = feedbackText;
            display.style.color = feedbackColor;
        }
        
        function finishPractice1() {
            stopAudio();
            practiceStage = 1;
            showPracticeStage();
        }
        
        function finishPractice2() {
            stopAudio();
            practiceStage = 2; // Mark practice as complete
            showPracticeStage();
        }
        
        function showExperimentInstructions() {
            const content = `
                <div class="instructions">
                    <h3>Ready for the Main Experiment</h3>
                    <p style="font-size: 1.1em; margin-bottom: 20px; font-weight: 500; color: #2d3748;">
                        Now, your task is to align the tones (beeps) with what you think is the first beat of the Indian rhythmic cycle, in the way that sounds best to you. The audio begins at a random beat.
                    </p>
                    <ul>
                        <li><strong>Experiment:</strong> You'll complete ${experimentTrials.length} trials with different rhythms</li>
                        <li><strong>Controls:</strong> Use ← and → arrows to shift the tones earlier or later</li>
                        <li><strong>Goal:</strong> Find the position where tones align best with the rhythm's first beat</li>
                        <li><strong>Visual Indicator:</strong> May provide you with feedback on your responses</li>
                    </ul>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startFirstTrial()">Begin Experiment</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        // Main experiment functions
        async function startFirstTrial() {
            currentTrialIndex = 0;
            await startTrial();
        }
        
        async function startTrial() {
            if (currentTrialIndex >= experimentTrials.length) {
                setTimeout(() => askAboutStrategies(), 1500);
                return;
            }
            
            currentTrial = experimentTrials[currentTrialIndex];
            
            updateStatus(`Loading trial ${currentTrial.trial_number}...`, 'warning');
            
            const audioLoaded = await loadTrialAudio(currentTrial);
            if (!audioLoaded) {
                return;
            }
            
            initialBeatOffset = Math.floor(Math.random() * (currentTrial.rhythm.beats_per_cycle - 1)) + 1;
            currentBeatOffset = initialBeatOffset;
            trialStartTime = Date.now();
            adjustmentCount = 0;
            currentPlaybackPosition = 0;
            isFirstPlay = true;
            
            // Always start blob at 12:00 position (0 degrees)
            cumulativeWheelAngle = 0;
            
            const content = `
                <div style="text-align: center; color: #718096; font-size: 0.9em; margin: 5px 0 3px 0; font-weight: 500;">Trial ${currentTrial.trial_number} of ${experimentTrials.length}</div>
                
                <div class="control-panel">
                    <div class="beat-display">
                        <div style="color: #718096; font-size: 0.9em;">Use arrows to adjust timing. You can adjust while audio is playing.</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="playAudio()" style="font-size: 1.2em; padding: 18px 35px;">▶ Play</button>
                        <button class="btn" onclick="pauseAudio()" style="font-size: 1.2em; padding: 18px 35px;">⏸ Pause</button>
                    </div>
                    
                    <div class="beat-controls">
                        <button class="beat-btn" onclick="adjustBeat(1)" title="Shift tones earlier">←</button>
                        <div style="text-align: center; color: #4a5568;">
                            <div style="font-weight: bold; font-size: 1.1em;">Timing Control</div>
                            <div style="font-size: 0.9em; margin-top: 5px;">← Earlier | Later →</div>
                        </div>
                        <button class="beat-btn" onclick="adjustBeat(-1)" title="Shift tones later">→</button>
                    </div>
                    
                    <div class="wheel-container">
                        <div class="wheel-label">Visual Indicator</div>
                        <div class="timing-wheel" id="timing-wheel">
                            <div class="wheel-base">
                                ${generateWheelTicks(currentTrial.rhythm.beats_per_cycle)}
                                <div class="wheel-pointer" id="wheel-pointer"></div>
                                <div class="wheel-center"></div>
                            </div>
                        </div>
                        <div class="wheel-labels">
                            Shows current timing adjustment
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-submit" onclick="submitTrial()">Submit This Trial</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            updateStatus('Ready! Click Play and use arrows to adjust alignment in real-time.', '');
            
            updateWheelVisualization();
        }
        
        async function loadTrialAudio(trial) {
            try {
                updateStatus(`Loading audio for ${trial.rhythm.name}...`, 'warning');
                
                const [rhythmBuffer, tonesBuffer] = await Promise.all([
                    loadAudioBuffer(trial.rhythm.stm1),
                    loadAudioBuffer(trial.rhythm.stm2)
                ]);
                
                audioBuffers.rhythm = rhythmBuffer;
                audioBuffers.tones = tonesBuffer;
                
                updateStatus(`Audio loaded for ${trial.rhythm.name}!`, 'success');
                return true;
                
            } catch (error) {
                console.error(`Audio loading failed for ${trial.rhythm.name}:`, error);
                updateStatus(`Failed to load audio for ${trial.rhythm.name}`, 'error');
                return false;
            }
        }
        
        async function playAudio() {
            if (!audioBuffers.rhythm || !audioBuffers.tones) {
                updateStatus('Audio not loaded', 'error');
                return false;
            }
            
            try {
                if (audioContext.state === 'suspended') {
                    console.log('Resuming suspended audio context...');
                    await audioContext.resume();
                }
                
                // Always stop any existing audio first to prevent overlap
                stopAudio();
                
                const now = audioContext.currentTime + 0.1;
                const toneOffset = currentBeatOffset * currentTrial.rhythm.beat_duration;
                
                let startPosition;
                if (isFirstPlay) {
                    // RESTORE: Random start within first cycle as per experimental design
                    const randomBeat = Math.floor(Math.random() * currentTrial.rhythm.beats_per_cycle) + 1;
                    startPosition = (randomBeat - 1) * currentTrial.rhythm.beat_duration;
                    currentPlaybackPosition = startPosition;
                    isFirstPlay = false;
                    console.log(`Random start at beat ${randomBeat} (${startPosition.toFixed(2)}s)`);
                } else {
                    startPosition = currentPlaybackPosition;
                }
                
                // Ensure we don't start beyond the audio duration
                if (startPosition >= audioBuffers.rhythm.duration) {
                    console.log('Start position beyond buffer, resetting to beginning');
                    startPosition = 0;
                    currentPlaybackPosition = 0;
                    isFirstPlay = true;
                }
                
                console.log(`Starting trial audio - Position: ${startPosition.toFixed(2)}s, Buffer duration: ${audioBuffers.rhythm.duration.toFixed(2)}s`);
                
                audioSources.rhythm = audioContext.createBufferSource();
                audioSources.rhythm.buffer = audioBuffers.rhythm;
                audioSources.rhythm.connect(gainNodes.rhythm);
                
                audioSources.tones = audioContext.createBufferSource();
                audioSources.tones.buffer = audioBuffers.tones;
                audioSources.tones.connect(gainNodes.tones);
                
                // Add error handlers
                audioSources.rhythm.onerror = (e) => {
                    console.error('Trial rhythm audio error:', e);
                    updateStatus('Trial rhythm audio error - click Play to restart', 'error');
                    isPlaying = false;
                };
                
                audioSources.tones.onerror = (e) => {
                    console.error('Trial tones audio error:', e);
                    updateStatus('Trial tones audio error - click Play to restart', 'error');
                    isPlaying = false;
                };
                
                // Start both audio sources
                audioSources.rhythm.start(now, startPosition);
                audioSources.tones.start(now, startPosition + toneOffset);
                
                // RESTORE: Fade-in until second cycle begins (experimental design requirement)
                const firstCycleDuration = currentTrial.rhythm.beats_per_cycle * currentTrial.rhythm.beat_duration;
                const shouldFadeIn = startPosition < firstCycleDuration;
                
                console.log(`First cycle duration: ${firstCycleDuration.toFixed(2)}s, Should fade in: ${shouldFadeIn}`);
                
                if (shouldFadeIn) {
                    const remainingFadeTime = Math.max(0.1, firstCycleDuration - startPosition);
                    console.log(`Fade duration: ${remainingFadeTime.toFixed(2)}s`);
                    
                    // Use LINEAR ramp instead of exponential - more reliable
                    gainNodes.rhythm.gain.setValueAtTime(0.05, now); // Start very quiet but not silent
                    gainNodes.rhythm.gain.linearRampToValueAtTime(0.7, now + remainingFadeTime);
                } else {
                    // Second cycle or later - start at full volume
                    gainNodes.rhythm.gain.setValueAtTime(0.7, now);
                }
                
                // Beeps always start at full volume for timing reference
                gainNodes.beeps.gain.setValueAtTime(0.8, now);
                
                isPlaying = true;
                playbackStartTime = now;
                
                updateStatus('Playing... Use arrows to adjust alignment in real-time', 'success');
                
                console.log('Trial audio started successfully with experimental design features restored');
                
                return true;
                
            } catch (error) {
                console.error('Trial audio playback error:', error);
                updateStatus('Audio playback failed. Try refreshing the page.', 'error');
                isPlaying = false;
                return false;
            }
        }
        
        function pauseAudio() {
            if (isPlaying) {
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                
                if (currentPlaybackPosition >= audioBuffers.rhythm.duration) {
                    currentPlaybackPosition = 0;
                }
            }
            
            stopAudio();
            updateStatus('Paused. Use arrows to adjust, then Play to resume.', '');
        }
        
        function generateWheelTicks(beatsPerCycle) {
            // Only show the starting position tick at 12 o'clock
            return `<div class="wheel-tick start-position" style="transform: rotate(0deg);"></div>`;
        }
        
        function adjustBeat(direction) {
            let newOffset = currentBeatOffset + direction;
            
            if (newOffset >= currentTrial.rhythm.beats_per_cycle) {
                newOffset = 0;
            } else if (newOffset < 0) {
                newOffset = currentTrial.rhythm.beats_per_cycle - 1;
            }
            
            currentBeatOffset = newOffset;
            adjustmentCount++;
            
            // Calculate angle per beat for this specific rhythm
            const anglePerBeat = 360 / currentTrial.rhythm.beats_per_cycle;
            
            // Move the blob continuously around the circle
            // Left arrow (direction 1) = counter-clockwise (subtract)
            // Right arrow (direction -1) = clockwise (add)
            cumulativeWheelAngle -= direction * anglePerBeat;
            
            updateWheelVisualization();
            
            if (isPlaying) {
                // RESTORE ORIGINAL: Immediate real-time adjustment like your original code
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                playAudio(); // Direct restart - no crossfading delays
                updateStatus('Alignment adjusted - audio continues with new timing', 'success');
            } else {
                updateStatus('Adjustment made. Click Play to hear the change.', '');
            }
        }
        
        function updateWheelVisualization() {
            const pointer = document.getElementById('wheel-pointer');
            if (!pointer) return;
            
            // Simply rotate the pointer based on cumulative angle
            pointer.style.transform = `rotate(${cumulativeWheelAngle}deg)`;
        }
        
        function submitTrial() {
            pauseAudio();
            
            const trialDuration = Date.now() - trialStartTime;
            
            const correctBeat = 0;
            const errorBeats = currentBeatOffset - correctBeat;
            const absoluteError = Math.abs(errorBeats);
            
            const trialData = {
                trial_number: currentTrial.trial_number,
                trial_id: currentTrial.trial_id,
                rhythm_name: currentTrial.rhythm.name,
                repetition: currentTrial.repetition,
                beats_per_cycle: currentTrial.rhythm.beats_per_cycle,
                
                initial_beat_offset: initialBeatOffset,
                final_beat_offset: currentBeatOffset,
                correct_beat_offset: correctBeat,
                error_beats: errorBeats,
                absolute_error_beats: absoluteError,
                total_adjustments: adjustmentCount,
                trial_duration_ms: trialDuration,
                trial_duration_sec: Math.round(trialDuration / 100) / 10
            };
            
            allTrialData.push(trialData);
            
            updateStatus('Trial completed!', 'success');
            
            currentTrialIndex++;
            
            if (currentTrialIndex >= experimentTrials.length) {
                setTimeout(() => askAboutStrategies(), 1500);
            } else {
                setTimeout(() => showNextTrialPrompt(), 1500);
            }
        }
        
        function showNextTrialPrompt() {
            const remaining = experimentTrials.length - currentTrialIndex;
            const lastTrial = allTrialData[allTrialData.length - 1];
            const alignedBeat = lastTrial.final_beat_offset + 1;
            
            let feedbackMessage = '';
            let feedbackColor = '';
            
            if (alignedBeat === 1) {
                feedbackMessage = "You aligned it to the first beat of the cycle. Great!";
                feedbackColor = "#38a169";
            } else {
                feedbackMessage = `You aligned the cycle to the ${getOrdinal(alignedBeat)} beat.`;
                feedbackColor = "#d69e2e";
            }
            
            const content = `
                <div class="info-box">
                    <p style="color: ${feedbackColor}; font-weight: bold; font-size: 1.2em; text-align: center; margin-bottom: 20px;">${feedbackMessage}</p>
                    
                    <div style="text-align: center; color: #4a5568; margin-top: 25px;">
                        <p>${remaining} more trial${remaining !== 1 ? 's' : ''} to go.</p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-next" onclick="startTrial()">Continue to Next Trial</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            updateStatus('Ready for next trial when you are.', '');
        }
        
        function getOrdinal(num) {
            const suffix = ["th", "st", "nd", "rd"];
            const v = num % 100;
            return num + (suffix[(v - 20) % 10] || suffix[v] || suffix[0]);
        }
        
        function askAboutStrategies() {
            const content = `
                <div class="trial-progress">
                    All ${experimentTrials.length} trials completed!
                </div>
                
                <div class="info-box">
                    <h3 style="color: #2d3748; margin-bottom: 20px;">Before we show your results...</h3>
                    <p style="color: #4a5568; margin-bottom: 20px;">
                        We're interested in understanding how you approached this task. Your insights help us improve our research.
                    </p>
                    
                    <div style="margin: 25px 0;">
                        <label style="display: block; color: #2d3748; font-weight: 500; margin-bottom: 10px;">
                            What strategies did you personally use while doing this alignment task? 
                            <span style="color: #718096; font-weight: normal;">(For example: Did you focus on certain sounds, rhythmic patterns, or use any particular approach?)</span>
                        </label>
                        <textarea id="strategies" 
                                style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 1em; resize: vertical;"
                                placeholder="Please describe any strategies, approaches, or things you focused on while aligning the rhythms..."></textarea>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveStrategiesAndShowResults()">Continue to Results</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            updateStatus('Share your approach to help us understand your experience.', '');
        }
        
        function saveStrategiesAndShowResults() {
            const strategies = document.getElementById('strategies')?.value || '';
            createParticipantRecord(strategies);
            showFinalResults();
        }
        
        function createParticipantRecord(strategies = '', taskFeedback = '') {
            const correctTrials = allTrialData.filter(trial => trial.final_beat_offset === 0).length;
            const totalTrials = allTrialData.length;
            const accuracyPercent = Math.round((correctTrials / totalTrials) * 100);
            
            const totalAdjustments = allTrialData.reduce((sum, trial) => sum + trial.total_adjustments, 0);
            const avgAdjustments = Math.round(totalAdjustments / totalTrials * 10) / 10;
            
            const totalDuration = allTrialData.reduce((sum, trial) => sum + trial.trial_duration_ms, 0);
            const avgTrialDuration = Math.round(totalDuration / totalTrials / 100) / 10;
            
            const absoluteErrors = allTrialData.map(trial => trial.absolute_error_beats);
            const avgAbsoluteError = Math.round((absoluteErrors.reduce((sum, err) => sum + err, 0) / totalTrials) * 10) / 10;
            
            const trialDetails = allTrialData.map(trial => 
                `${trial.rhythm_name}_R${trial.repetition}:${trial.final_beat_offset}`
            ).join(';');
            
            const trialErrors = allTrialData.map(trial => trial.error_beats).join(';');
            const trialDurations = allTrialData.map(trial => trial.trial_duration_sec).join(';');
            const trialAdjustments = allTrialData.map(trial => trial.total_adjustments).join(';');
            
            const participantRecord = {
                participant_id: participantId,
                timestamp: new Date().toISOString(),
                age: participantAge,
                nationality: surveyData.nationality,
                ethnicity: surveyData.ethnicity,
                
                indian_music_familiarity: surveyData.indianMusicFamiliarity,
                indian_music_genres: surveyData.indianMusicGenres.join(';'),
                hindustani_training: surveyData.hindustaniTraining,
                hindustani_years: surveyData.hindustaniYears,
                hindustani_familiarity_score: surveyData.hindustaniFamiliarityScore,
                hindustani_familiarity_answers: surveyData.hindustaniFamiliarityAnswers.join(';'),
                musician_type: surveyData.musicianType,
                musical_training_years: surveyData.musicalTrainingYears,
                musical_training_type: surveyData.musicalTrainingType,
                
                total_trials: totalTrials,
                correct_trials: correctTrials,
                accuracy_percent: accuracyPercent,
                avg_absolute_error: avgAbsoluteError,
                avg_adjustments_per_trial: avgAdjustments,
                avg_trial_duration_sec: avgTrialDuration,
                
                jhaptal_trials_correct: allTrialData.filter(t => t.rhythm_name === 'Jhaptal' && t.final_beat_offset === 0).length,
                keherva_trials_correct: allTrialData.filter(t => t.rhythm_name === 'Keherva' && t.final_beat_offset === 0).length,
                rupak_trials_correct: allTrialData.filter(t => t.rhythm_name === 'Rupak' && t.final_beat_offset === 0).length,
                teental_trials_correct: allTrialData.filter(t => t.rhythm_name === 'Teental' && t.final_beat_offset === 0).length,
                
                trial_details: trialDetails,
                trial_errors: trialErrors,
                trial_durations_sec: trialDurations,
                trial_adjustments: trialAdjustments,
                
                participant_strategies: strategies,
                task_feedback: taskFeedback
            };
            
            allTrialData = [participantRecord];
        }
        
        function showFinalResults() {
            const participantRecord = allTrialData[0];
            const totalTrials = participantRecord.total_trials;
            const correctTrials = participantRecord.correct_trials;
            
            const content = `
                <div class="status success">
                    All data submitted successfully!
                </div>
                
                <div class="info-box">
                    <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">Let us understand the results</h3>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="font-size: 3em; font-weight: bold; color: #667eea; margin-bottom: 15px;">
                            ${correctTrials}/${totalTrials}
                        </div>
                        <div style="font-size: 1.3em; color: #4a5568; margin-bottom: 10px;">
                            Rhythmic cycles aligned on the first beat of the rhythmic cycle
                        </div>
                    </div>
                    
                    <div style="background: rgba(102, 126, 234, 0.05); padding: 25px; border-radius: 10px; border-left: 4px solid #667eea; margin: 30px 0;">
                        <h4 style="color: #2d3748; margin-bottom: 15px;">Understanding Your Results</h4>
                        <p style="color: #4a5568; line-height: 1.6; margin-bottom: 15px;">
                            This result is not a reflection of your musical ability or performance. These rhythms are deeply rooted in specific cultural contexts and require specialised learning to recognise accurately. Performance depends greatly on your cultural background and musical training.
                        </p>
                        <p style="color: #4a5568; line-height: 1.6; margin-bottom: 15px;">
                            Anyone who is not trained in recognising these rhythms will focus on different features than those who are familiar with them. This difference in perception is completely normal and reflects the cultural specificity of music.
                        </p>
                        <p style="color: #4a5568; line-height: 1.6; font-weight: 500;">
                            Our participants are musicians, non-musicians from South Asian/Indian and western backgrounds. We are studying how cultural differences in rhythm perception emerge and vary across different backgrounds.
                        </p>
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e2e8f0; color: #4a5568; text-align: center;">
                        <p>Thank you for participating! Your data helps us understand how rhythm perception varies across different cultural and musical backgrounds and adds to the body of knowledge. Your data is confidential and safe, and will only be used for academic purposes.</p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="askTaskFeedback()">Continue</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function askTaskFeedback() {
            const content = `
                <div class="info-box">
                    <h3 style="color: #2d3748; margin-bottom: 20px;">Help us improve this experiment</h3>
                    <p style="color: #4a5568; margin-bottom: 20px;">
                        Your feedback helps us make this research better for future participants. You're part of our research journey!
                    </p>
                    
                    <div style="margin: 25px 0;">
                        <label style="display: block; color: #2d3748; font-weight: 500; margin-bottom: 10px;">
                            So, please tell us What did you think about this task? <span style="color: #718096; font-style: italic;">(Optional)</span>
                            <span style="color: #718096; font-weight: normal;">(Was anything confusing? Did the interface work well? Any suggestions for improvement?)</span>
                        </label>
                        <textarea id="task-feedback" 
                                style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 1em; resize: vertical;"
                                placeholder="Please share your thoughts about the experiment, interface, instructions, or any suggestions..."></textarea>
                    </div>
                    
                    <div style="margin: 25px 0;">
                        <label style="display: block; color: #2d3748; font-weight: 500; margin-bottom: 10px;">
                            Please provide your email if you would like to be a part of similar studies:
                        </label>
                        <input type="email" id="participant-email" 
                                style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;"
                                placeholder="your.email@example.com (optional)">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="submitTaskFeedbackAndFinish()">Submit Feedback & Complete</button>
                    <button class="btn" onclick="finishWithoutFeedback()" style="background: #a0aec0;">Skip Feedback</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            updateStatus('Your feedback helps improve the participant experience.', '');
        }
        
        function submitTaskFeedbackAndFinish() {
            const taskFeedback = document.getElementById('task-feedback')?.value || '';
            const participantEmail = document.getElementById('participant-email')?.value || '';
            
            if (allTrialData.length > 0) {
                allTrialData[0].task_feedback = taskFeedback;
                allTrialData[0].participant_email = participantEmail;
            }
            
            finishExperiment();
        }
        
        function finishWithoutFeedback() {
            finishExperiment();
        }
        
        async function finishExperiment() {
            const content = `
                <div class="info-box">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">Experiment Complete!</h3>
                    <p>Submitting your data...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress"></div>
                    </div>
                </div>
                
                <div id="submission-status" class="status warning">
                    Submitting data...
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            
            setTimeout(() => {
                document.getElementById('progress').style.width = '100%';
            }, 500);
            
            try {
                const csvData = convertToCSV(allTrialData);
                await submitToGoogleForms(csvData);
                
                showFinalCompletion();
                
            } catch (error) {
                console.error('Submission failed:', error);
                
                document.getElementById('submission-status').innerHTML = 
                    '<span class="error">Submission failed. Downloading backup data...</span>';
                
                downloadBackup(convertToCSV(allTrialData));
                showFinalCompletion();
            }
        }
        
        function showFinalCompletion() {
            const content = `
                <div class="status success">
                    All data submitted successfully!
                </div>
                
                <div class="info-box">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">Thank You!</h3>
                    <p style="color: #4a5568; line-height: 1.6;">
                        You have successfully completed the rhythm alignment study. Your participation and feedback 
                        contribute valuable insights to our understanding of cross-cultural rhythm perception.
                    </p>
                    <br>
                    <p style="font-size: 0.9em; color: #718096; text-align: center;">You may now close this window.</p>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        // Data submission functions
        async function submitToGoogleForms(csvData) {
            const formData = new FormData();
            formData.append(CONFIG.GOOGLE_FORMS.fields.participant_id, participantId);
            formData.append(CONFIG.GOOGLE_FORMS.fields.trial_data, csvData);
            
            if (participantAge && participantAge.trim() !== '') {
                formData.append(CONFIG.GOOGLE_FORMS.fields.age, participantAge);
            }
            
            if (allTrialData.length > 0 && allTrialData[0].participant_strategies) {
                formData.append(CONFIG.GOOGLE_FORMS.fields.strategies, allTrialData[0].participant_strategies);
            }
            
            await fetch(CONFIG.GOOGLE_FORMS.form_url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            });
        }
        
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(row => 
                Object.values(row).map(value => 
                    typeof value === 'string' ? `"${value}"` : value
                ).join(',')
            );
            
            return headers + '\n' + rows.join('\n');
        }
        
        function downloadBackup(csvData) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${participantId}_rhythm_alignment_full.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Utility functions
        function updateStatus(message, type = '') {
            const statusEl = document.getElementById('status-text') || document.getElementById('submission-status');
            if (statusEl) {
                statusEl.textContent = message;
                const statusContainer = statusEl.closest('.status');
                if (statusContainer) {
                    statusContainer.className = `status ${type}`;
                }
            }
            if (!statusEl) {
                console.log(`Status: ${message} (${type})`);
            }
        }
        
        // Experiment initialization
        async function startExperiment() {
            console.log('Starting experiment...');
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('experiment-content').style.display = 'block';
            
            console.log('Initializing audio...');
            const audioInit = await initializeAudio();
            if (!audioInit) {
                updateStatus('⌫ Audio initialization failed - please refresh and try again', 'error');
                return;
            }
            
            console.log('Audio initialized, state:', audioContext.state);
            
            try {
                // Unlock audio context with a silent buffer (required for some browsers)
                console.log('Creating silent buffer for audio unlock...');
                const silentBuffer = audioContext.createBuffer(1, 1, audioContext.sampleRate);
                const silentSource = audioContext.createBufferSource();
                silentSource.buffer = silentBuffer;
                silentSource.connect(audioContext.destination);
                silentSource.start();
                console.log('Silent buffer played for audio unlock');
            } catch (e) {
                console.log('Safari audio unlock failed (this is normal):', e);
            }
            
            experimentTrials = generateTrials();
            console.log('Generated', experimentTrials.length, 'trials');
            
            showConsentForm();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (document.querySelector('.control-panel')) {
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    if (currentPractice) {
                        adjustPracticeBeat(1);
                    } else {
                        adjustBeat(1);
                    }
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    if (currentPractice) {
                        adjustPracticeBeat(-1);
                    } else {
                        adjustBeat(-1);
                    }
                } else if (event.key === ' ') {
                    event.preventDefault();
                    if (isPlaying) {
                        pauseAudio();
                    } else {
                        if (currentPractice) {
                            playPracticeAudio();
                        } else {
                            playAudio();
                        }
                    }
                }
            }
        });
        
        // Global function declarations
        window.startExperiment = startExperiment;
        window.showConsentForm = showConsentForm;
        window.handleConsent = handleConsent;
        window.showBackgroundQuestionnaire = showBackgroundQuestionnaire;
        window.toggleIndianMusicQuestions = toggleIndianMusicQuestions;
        window.toggleHindustaniYears = toggleHindustaniYears;
        window.toggleMusicTrainingQuestions = toggleMusicTrainingQuestions;
        window.toggleMusicTrainingQuestionsMain = toggleMusicTrainingQuestionsMain;
        window.updateIndianGenres = updateIndianGenres;
        window.showFamiliarityQuestion = showFamiliarityQuestion;
        window.handleFamiliarityAnswer = handleFamiliarityAnswer;
        window.showFamiliarityResults = showFamiliarityResults;
        window.submitBackgroundQuestionnaire = submitBackgroundQuestionnaire;
        window.showExamplePage = showExamplePage;
        window.showInstructions = showInstructions;
        window.loadExampleAudio = loadExampleAudio;
        window.playExampleAudio = playExampleAudio;
        window.stopExampleAudio = stopExampleAudio;
        window.loadAndStartPractice1 = loadAndStartPractice1;
        window.startPractice = startPractice;
        window.showPracticeStage = showPracticeStage;
        window.showPractice2 = showPractice2;
        window.playPracticeAudio = playPracticeAudio;
        window.adjustPracticeBeat = adjustPracticeBeat;
        window.updatePracticeFeedback = updatePracticeFeedback;
        window.finishPractice1 = finishPractice1;
        window.finishPractice2 = finishPractice2;
        window.showExperimentInstructions = showExperimentInstructions;
        window.startFirstTrial = startFirstTrial;
        window.startTrial = startTrial;
        window.playAudio = playAudio;
        window.pauseAudio = pauseAudio;
        window.adjustBeat = adjustBeat;
        window.submitTrial = submitTrial;
        window.createParticipantRecord = createParticipantRecord;
        window.askAboutStrategies = askAboutStrategies;
        window.saveStrategiesAndShowResults = saveStrategiesAndShowResults;
        window.askTaskFeedback = askTaskFeedback;
        window.submitTaskFeedbackAndFinish = submitTaskFeedbackAndFinish;
        window.finishWithoutFeedback = finishWithoutFeedback;
        window.selectAllData = selectAllData;
        
    </script>
</body>
</html>