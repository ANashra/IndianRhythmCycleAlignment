<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Cycle Alignment Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .participant-id {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-align: center;
            font-family: monospace;
            font-weight: bold;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .status {
            background: rgba(66, 153, 225, 0.1);
            border: 1px solid #4299e1;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
        }

        .status.success { 
            background: rgba(72, 187, 120, 0.1); 
            border-color: #48bb78; 
            color: #2f855a; 
        }

        .status.warning { 
            background: rgba(237, 137, 54, 0.1); 
            border-color: #ed8936; 
            color: #c05621; 
        }

        .status.error { 
            background: rgba(229, 62, 62, 0.1); 
            border-color: #e53e3e; 
            color: #c53030; 
        }

        .btn {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.4);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #48bb78, #38a169);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .btn-submit {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            font-size: 1.3em;
            padding: 18px 40px;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .btn-submit:hover {
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.4);
        }

        .control-panel {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 30px;
            border-radius: 15px;
            margin: 25px 0;
            border: 1px solid #e2e8f0;
        }

        .beat-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 30px 0;
        }

        .beat-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 2em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .beat-btn:active {
            transform: scale(0.95);
        }

        .beat-display {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        /* Circular Wheel Styles - Visual Only */
        .wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
            padding: 25px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
        }

        .wheel-label {
            font-size: 1.1em;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 20px;
        }

        .timing-wheel {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 20px 0;
            pointer-events: none; /* Make it purely visual */
        }

        .wheel-base {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 3px solid #e2e8f0;
            box-shadow: 
                inset 0 4px 8px rgba(0, 0, 0, 0.1),
                0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .wheel-tick {
            position: absolute;
            width: 3px;
            height: 20px;
            background: #a0aec0;
            border-radius: 1.5px;
            transform-origin: 50% 100px; /* Center of circle */
            top: 10px;
            left: 50%;
            margin-left: -1.5px;
        }

        .wheel-tick.start-position {
            background: #4299e1;
            width: 4px;
            height: 25px;
            margin-left: -2px;
            top: 7.5px;
            box-shadow: 0 2px 6px rgba(66, 153, 225, 0.4);
        }

        .wheel-pointer {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 25px solid #667eea;
            top: 15px;
            left: 50%;
            transform-origin: 50% 85px; /* Point to center of circle */
            margin-left: -10px;
            filter: drop-shadow(0 3px 6px rgba(102, 126, 234, 0.4));
            transition: transform 0.3s ease;
            z-index: 10;
        }

        .wheel-center {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            top: 50%;
            left: 50%;
            margin: -10px 0 0 -10px;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
            z-index: 15;
        }

        .wheel-labels {
            text-align: center;
            font-size: 0.9em;
            color: #718096;
            margin-top: 15px;
            font-weight: 500;
        }

        .info-box {
            background: linear-gradient(135deg, #ebf8ff, #bee3f8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3182ce;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.8);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #4299e1;
        }

        .instructions h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .instructions ul {
            color: #4a5568;
            line-height: 1.6;
        }

        .instructions li {
            margin: 8px 0;
        }

        input[type="text"], input[type="number"] {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin: 8px;
            font-size: 1em;
            width: 200px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #4299e1;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #48bb78, #38a169);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .beat-controls {
                gap: 20px;
            }
            
            .beat-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rhythm Cycle Alignment Study</h1>
        <p class="subtitle">Musical Rhythm Perception Research</p>
        
        <div id="status" class="status">
            <span id="status-text">Ready to begin the experiment</span>
        </div>
        
        <button id="start-btn" class="btn btn-submit" onclick="startExperiment()">Start Experiment</button>
        
        <div id="experiment-content" style="display: none;">
            <!-- Experiment content will be inserted here -->
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const CONFIG = {
            GOOGLE_FORMS: {
                form_url: 'https://docs.google.com/forms/d/e/1FAIpQLSe_FwttiN7E5Ma-8PWgjhbXGww96pp20rOQJdjvZHOw3mLQkw/formResponse',
                fields: {
                    participant_id: 'entry.1163885589',
                    trial_data: 'entry.112861185',
                    age: 'entry.271345687'
                }
            },
            AUDIO: {
                beat_duration: 0.57143, // 571.43 milliseconds
                beats_per_cycle: 7,
                total_cycles: 24,
                files: {
                    rhythm: 'audio/Rupak_Stm1_4.mp3',
                    tones: 'audio/Rupak_Stm2_4.mp3'
                }
            }
        };
        
        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        
        let audioContext;
        let audioBuffers = { rhythm: null, tones: null };
        let audioSources = { rhythm: null, tones: null };
        let gainNodes = { rhythm: null, tones: null };
        
        let participantId = 'RHYTHM_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        let currentBeatOffset = 0; // Beat offset for tone alignment
        let initialBeatOffset = 0; // Starting misalignment
        let isPlaying = false;
        let currentPlaybackPosition = 0; // Track where we are in the audio
        let playbackStartTime = 0; // When playback started
        let isFirstPlay = true; // Track if this is the first play of the trial
        let trialStartTime = 0;
        let adjustmentCount = 0;
        let experimentData = [];
        
        // ==========================================
        // AUDIO FUNCTIONS
        // ==========================================
        
        async function initializeAudio() {
            try {
                // Safari-specific: Create AudioContext with user gesture
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Safari fix: Ensure audio context is not suspended
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                // Create gain nodes for volume control
                gainNodes.rhythm = audioContext.createGain();
                gainNodes.tones = audioContext.createGain();
                
                gainNodes.rhythm.connect(audioContext.destination);
                gainNodes.tones.connect(audioContext.destination);
                
                // Set initial volumes - both start normally, fade-in handled in playAudio()
                gainNodes.rhythm.gain.value = 0.7;
                gainNodes.tones.gain.value = 0.8;
                
                console.log('Audio context state:', audioContext.state);
                return true;
            } catch (error) {
                console.error('Audio initialization failed:', error);
                return false;
            }
        }
        
        async function loadAudioFiles() {
            try {
                updateStatus('Loading audio files...', 'warning');
                
                // Safari detection for debugging
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                if (isSafari) {
                    console.log('Safari detected - using Safari-specific audio loading');
                }
                
                const [rhythmBuffer, tonesBuffer] = await Promise.all([
                    loadAudioBuffer(CONFIG.AUDIO.files.rhythm),
                    loadAudioBuffer(CONFIG.AUDIO.files.tones)
                ]);
                
                audioBuffers.rhythm = rhythmBuffer;
                audioBuffers.tones = tonesBuffer;
                
                console.log('Audio buffers loaded:', {
                    rhythm: audioBuffers.rhythm ? 'OK' : 'FAILED',
                    tones: audioBuffers.tones ? 'OK' : 'FAILED',
                    rhythmDuration: audioBuffers.rhythm?.duration,
                    tonesDuration: audioBuffers.tones?.duration
                });
                
                updateStatus('Audio files loaded successfully!', 'success');
                return true;
                
            } catch (error) {
                console.error('Audio loading failed:', error);
                updateStatus('Failed to load audio files. Please check file paths.', 'error');
                
                // Safari-specific error message
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                const errorMsg = isSafari 
                    ? `Safari audio loading failed: ${error.message}\n\nTry:\n1. Refreshing the page\n2. Checking if files are .mp3 format\n3. Enabling autoplay in Safari settings`
                    : `Audio loading failed: ${error.message}\n\nPlease ensure:\n1. Audio files are in the 'audio/' folder\n2. File names are correct\n3. You're running from a web server`;
                
                alert(errorMsg);
                return false;
            }
        }
        
        async function loadAudioBuffer(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Could not load ${url}`);
            }
            const arrayBuffer = await response.arrayBuffer();
            return await audioContext.decodeAudioData(arrayBuffer);
        }
        
        async function playAudio() {
            if (!audioBuffers.rhythm || !audioBuffers.tones) {
                updateStatus('Audio not loaded', 'error');
                return false;
            }
            
            try {
                // Safari fix: Always try to resume audio context on play
                if (audioContext.state === 'suspended') {
                    console.log('Resuming suspended audio context...');
                    await audioContext.resume();
                    console.log('Audio context resumed, state:', audioContext.state);
                }
                
                // Additional Safari fix: Small delay to ensure context is ready
                if (audioContext.state !== 'running') {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                }
                
                // Stop any currently playing audio
                stopAudio();
                
                const now = audioContext.currentTime + 0.1; // Small delay for smooth start
                const toneOffset = currentBeatOffset * CONFIG.AUDIO.beat_duration;
                
                // Determine starting position
                let startPosition;
                if (isFirstPlay) {
                    // Random starting beat (1-7) on first play
                    const randomBeat = Math.floor(Math.random() * 7) + 1; // 1 to 7
                    startPosition = (randomBeat - 1) * CONFIG.AUDIO.beat_duration;
                    currentPlaybackPosition = startPosition;
                    isFirstPlay = false;
                } else {
                    // Use current playback position for pause/resume
                    startPosition = currentPlaybackPosition;
                }
                
                // Play rhythm track from start position
                audioSources.rhythm = audioContext.createBufferSource();
                audioSources.rhythm.buffer = audioBuffers.rhythm;
                audioSources.rhythm.connect(gainNodes.rhythm);
                audioSources.rhythm.start(now, startPosition);
                
                // Play tones track with offset from start position
                audioSources.tones = audioContext.createBufferSource();
                audioSources.tones.buffer = audioBuffers.tones;
                audioSources.tones.connect(gainNodes.tones);
                audioSources.tones.start(now, startPosition + toneOffset);
                
                // Add fade-in effect to Stm1 (rhythm) only: fade in over first cycle (7 beats = ~4 seconds)
                const firstCycleDuration = CONFIG.AUDIO.beats_per_cycle * CONFIG.AUDIO.beat_duration; // ~4 seconds
                
                // Check if we should apply fade-in (only when starting from beginning or early in track)
                const shouldFadeIn = startPosition < firstCycleDuration;
                
                if (shouldFadeIn) {
                    // Calculate how much of the fade-in period remains
                    const remainingFadeTime = Math.max(0.1, firstCycleDuration - startPosition); // Minimum 0.1 seconds
                    const fadeEndTime = now + remainingFadeTime;
                    
                    // Start rhythm from silence and fade to full volume
                    gainNodes.rhythm.gain.setValueAtTime(0.001, now); // Very quiet start
                    gainNodes.rhythm.gain.exponentialRampToValueAtTime(0.7, fadeEndTime);
                } else {
                    // No fade-in needed - set rhythm to full volume immediately
                    gainNodes.rhythm.gain.setValueAtTime(0.7, now);
                }
                
                // Stm2 (tones) always at full volume - no fade-in
                gainNodes.tones.gain.setValueAtTime(0.8, now);
                
                isPlaying = true;
                playbackStartTime = now;
                
                updateStatus('Playing... Use arrows to adjust alignment in real-time', 'success');
                
                // Auto-stop after buffer duration
                const remainingDuration = audioBuffers.rhythm.duration - startPosition;
                setTimeout(() => {
                    if (isPlaying) {
                        // Reset for replay when audio finishes
                        currentPlaybackPosition = 0;
                        isFirstPlay = true;
                        stopAudio();
                        updateStatus('Audio finished. Click Play to listen again from the beginning.', '');
                    }
                }, remainingDuration * 1000);
                
                return true;
                
            } catch (error) {
                console.error('Safari audio playback error:', error);
                updateStatus('Audio playback failed. Try refreshing the page.', 'error');
                return false;
            }
        }
        
        function pauseAudio() {
            if (isPlaying) {
                // Calculate current playback position
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                
                // Ensure we don't go beyond the audio duration
                if (currentPlaybackPosition >= audioBuffers.rhythm.duration) {
                    currentPlaybackPosition = 0; // Reset if we've reached the end
                }
            }
            
            stopAudio();
            updateStatus('Paused. Use arrows to adjust, then Play to resume.', '');
        }
        
        function stopAudio() {
            Object.values(audioSources).forEach(source => {
                if (source) {
                    try { source.stop(); } catch(e) {}
                }
            });
            audioSources.rhythm = null;
            audioSources.tones = null;
            isPlaying = false;
        }
        
        // ==========================================
        // EXPERIMENT FUNCTIONS
        // ==========================================
        
        async function startExperiment() {
            updateStatus('Initializing audio system...', 'warning');
            
            // Safari fix: Initialize audio context within user gesture
            const audioInit = await initializeAudio();
            if (!audioInit) {
                updateStatus('Audio initialization failed', 'error');
                return;
            }
            
            // Safari fix: Create a silent audio buffer to unlock audio
            try {
                const silentBuffer = audioContext.createBuffer(1, 1, audioContext.sampleRate);
                const silentSource = audioContext.createBufferSource();
                silentSource.buffer = silentBuffer;
                silentSource.connect(audioContext.destination);
                silentSource.start();
                console.log('Safari audio unlock attempted');
            } catch (e) {
                console.log('Safari audio unlock failed:', e);
            }
            
            const audioLoaded = await loadAudioFiles();
            if (!audioLoaded) {
                return;
            }
            
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('experiment-content').style.display = 'block';
            
            showInstructions();
        }
        
        function showInstructions() {
            const content = `
                <div class="participant-id">Participant ID: ${participantId}</div>
                
                <div class="instructions">
                    <h3>Instructions</h3>
                    <ul>
                        <li><strong>Task:</strong> Align the tone beeps with the rhythm track</li>
                        <li><strong>Audio:</strong> You'll hear 24 cycles of a 7-beat rhythm (~2 minutes)</li>
                        <li><strong>Controls:</strong> Use ← and → arrows to shift the tones earlier or later</li>
                        <li><strong>Goal:</strong> Find the position where tones align best with the rhythm's first beat</li>
                        <li><strong>Tip:</strong> You can adjust timing while audio plays for real-time feedback</li>
                    </ul>
                </div>
                
                <div class="info-box">
                    <p><strong>Age (optional):</strong> <input type="number" id="age" placeholder="Enter your age" min="1" max="120"></p>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startTrial()">Begin Trial</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function startTrial() {
            // Set random initial misalignment (1-6 beats off)
            initialBeatOffset = Math.floor(Math.random() * 6) + 1;  // 1 to 6
            currentBeatOffset = initialBeatOffset;
            
            trialStartTime = Date.now();
            adjustmentCount = 0;
            
            // Reset for new trial
            currentPlaybackPosition = 0;
            isFirstPlay = true;
            
            const content = `
                <div class="control-panel">
                    <div class="beat-display">
                        <div style="color: #718096; font-size: 0.95em; margin-top: 8px;">Use the arrows below to adjust the timing of the tone/beep. You can adjust while audio is playing for immediate feedback.</div>
                    </div>
                    
                    <div class="beat-controls">
                        <button class="beat-btn" onclick="adjustBeat(1)" title="Shift tones earlier">←</button>
                        <div style="text-align: center; color: #4a5568;">
                            <div style="font-weight: bold; font-size: 1.1em;">Timing Control</div>
                            <div style="font-size: 0.9em; margin-top: 5px;">← Earlier | Later →</div>
                        </div>
                        <button class="beat-btn" onclick="adjustBeat(-1)" title="Shift tones later">→</button>
                    </div>
                    
                    <div class="wheel-container">
                        <div class="wheel-label">Visual Indicator</div>
                        <div class="timing-wheel" id="timing-wheel">
                            <div class="wheel-base">
                                <div class="wheel-tick" style="transform: rotate(0deg);"></div>
                                <div class="wheel-tick" style="transform: rotate(51.43deg);"></div>
                                <div class="wheel-tick" style="transform: rotate(102.86deg);"></div>
                                <div class="wheel-tick" style="transform: rotate(154.29deg);"></div>
                                <div class="wheel-tick" style="transform: rotate(205.71deg);"></div>
                                <div class="wheel-tick" style="transform: rotate(257.14deg);"></div>
                                <div class="wheel-tick" style="transform: rotate(308.57deg);"></div>
                                <div class="wheel-tick start-position" style="transform: rotate(0deg);"></div>
                                <div class="wheel-pointer" id="wheel-pointer"></div>
                                <div class="wheel-center"></div>
                            </div>
                        </div>
                        <div class="wheel-labels">
                            Shows current timing adjustment
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="playAudio()">▶ Play</button>
                        <button class="btn" onclick="pauseAudio()">⏸ Pause</button>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-submit" onclick="submitTrial()">Submit Final Answer</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            updateStatus('Ready! Click Play and use arrows to adjust alignment in real-time.', '');
            
            // Initialize wheel position
            updateWheelVisualization();
        }
        
        function adjustBeat(direction) {
            let newOffset = currentBeatOffset + direction;
            
            // Wrap around the 7-beat cycle
            if (newOffset >= CONFIG.AUDIO.beats_per_cycle) {
                newOffset = 0;
            } else if (newOffset < 0) {
                newOffset = CONFIG.AUDIO.beats_per_cycle - 1;
            }
            
            currentBeatOffset = newOffset;
            adjustmentCount++;
            
            // Update visual wheel
            updateWheelVisualization();
            
            // Handle audio restart if playing
            if (isPlaying) {
                // Calculate where we are now
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                
                // Restart audio from current position with new alignment
                playAudio();
                updateStatus('Alignment adjusted - audio continues with new timing', 'success');
            } else {
                updateStatus('Adjustment made. Click Play to hear the change.', '');
            }
        }
        
        function updateWheelVisualization() {
            const pointer = document.getElementById('wheel-pointer');
            if (!pointer) return;
            
            // Calculate how many steps we've moved from initial position
            let offsetFromInitial = currentBeatOffset - initialBeatOffset;
            
            // Handle wrapping properly (shortest path around the circle)
            if (offsetFromInitial > 3) {
                offsetFromInitial -= 7;
            } else if (offsetFromInitial < -3) {
                offsetFromInitial += 7;
            }
            
            // Convert to visual angle - each position is 51.43 degrees apart
            // Negative offset because we want "earlier" (left arrow) to move clockwise
            const angle = -offsetFromInitial * 51.43;
            
            // Update pointer rotation with precise alignment
            pointer.style.transform = `rotate(${angle}deg)`;
        }
        
        function submitTrial() {
            pauseAudio();
            
            const trialDuration = Date.now() - trialStartTime;
            const age = document.getElementById('age')?.value || '';
            
            // Calculate error (assuming beat 1 is correct alignment, so beat offset 0)
            const correctBeat = 0; // Beat 0 = Beat 1 in display
            const errorBeats = currentBeatOffset - correctBeat;
            const absoluteError = Math.abs(errorBeats);
            
            const trialData = {
                participant_id: participantId,
                timestamp: new Date().toISOString(),
                age: age,
                
                // Trial configuration
                rhythm_file: CONFIG.AUDIO.files.rhythm,
                tones_file: CONFIG.AUDIO.files.tones,
                beat_duration_ms: CONFIG.AUDIO.beat_duration * 1000,
                beats_per_cycle: CONFIG.AUDIO.beats_per_cycle,
                total_cycles: CONFIG.AUDIO.total_cycles,
                
                // Participant response
                initial_beat_offset: initialBeatOffset,
                final_beat_offset: currentBeatOffset,
                correct_beat_offset: correctBeat,
                
                // Performance metrics
                error_beats: errorBeats,
                absolute_error_beats: absoluteError,
                total_adjustments: adjustmentCount,
                trial_duration_ms: trialDuration,
                trial_duration_sec: Math.round(trialDuration / 100) / 10
            };
            
            experimentData.push(trialData);
            
            updateStatus('Trial completed! Preparing to submit data...', 'success');
            setTimeout(() => finishExperiment(trialData), 1500);
        }
        
        async function finishExperiment(data) {
            const content = `
                <div class="participant-id">Participant ID: ${participantId}</div>
                
                <div class="info-box">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">Experiment Complete!</h3>
                    <p>Submitting your data...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress"></div>
                    </div>
                </div>
                
                <div id="submission-status" class="status warning">
                    Submitting data...
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            
            // Animate progress bar
            setTimeout(() => {
                document.getElementById('progress').style.width = '100%';
            }, 500);
            
            try {
                const csvData = convertToCSV([data]);
                await submitToGoogleForms(data, csvData);
                
                showResults(data);
                
            } catch (error) {
                console.error('Submission failed:', error);
                
                document.getElementById('submission-status').innerHTML = 
                    '<span class="error">Submission failed. Downloading backup data...</span>';
                
                downloadBackup(convertToCSV([data]));
                showResults(data);
            }
        }
        
        function showResults(data) {
            const finalBeat = data.final_beat_offset + 1; // Convert to 1-based display
            const correctBeat = 1; // Beat 1 is the target
            const isCorrect = finalBeat === correctBeat;
            
            let resultMessage = '';
            if (isCorrect) {
                resultMessage = `<span style="color: #38a169; font-weight: bold;">Excellent! You correctly aligned the tones with beat 1!</span>`;
            } else {
                resultMessage = `<span style="color: #d69e2e; font-weight: bold;">You aligned the tones with beat ${finalBeat}. The target was beat 1.</span>`;
            }
            
            const content = `
                <div class="participant-id">Participant ID: ${participantId}</div>
                
                <div class="status success">
                    Data submitted successfully!
                </div>
                
                <div class="info-box">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">Thank You!</h3>
                    <p>${resultMessage}</p>
                    <br>
                    <p>Your data helps us understand rhythm perception. You may now close this window.</p>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        // ==========================================
        // DATA SUBMISSION
        // ==========================================
        
        async function submitToGoogleForms(data, csvData) {
            const formData = new FormData();
            formData.append(CONFIG.GOOGLE_FORMS.fields.participant_id, data.participant_id);
            formData.append(CONFIG.GOOGLE_FORMS.fields.trial_data, csvData);
            
            if (data.age && data.age.trim() !== '') {
                formData.append(CONFIG.GOOGLE_FORMS.fields.age, data.age);
            }
            
            await fetch(CONFIG.GOOGLE_FORMS.form_url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            });
        }
        
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(row => 
                Object.values(row).map(value => 
                    typeof value === 'string' ? `"${value}"` : value
                ).join(',')
            );
            
            return headers + '\n' + rows.join('\n');
        }
        
        function downloadBackup(csvData) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${participantId}_rhythm_alignment.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        function updateStatus(message, type = '') {
            const statusEl = document.getElementById('status-text') || document.getElementById('submission-status');
            if (statusEl) {
                statusEl.textContent = message;
                const statusContainer = statusEl.closest('.status');
                if (statusContainer) {
                    statusContainer.className = `status ${type}`;
                }
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (document.querySelector('.control-panel')) { // Only when in trial
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    adjustBeat(1); // Left arrow makes tones earlier
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    adjustBeat(-1); // Right arrow makes tones later
                } else if (event.key === ' ') {
                    event.preventDefault();
                    if (isPlaying) {
                        pauseAudio();
                    } else {
                        playAudio();
                    }
                }
            }
        });
        
        // Make functions global for onclick handlers
        window.startExperiment = startExperiment;
        window.startTrial = startTrial;
        window.playAudio = playAudio;
        window.pauseAudio = pauseAudio;
        window.adjustBeat = adjustBeat;
        window.submitTrial = submitTrial;
        
    </script>
</body>
</html>