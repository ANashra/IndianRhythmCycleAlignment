<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Cycle Alignment Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .status {
            background: rgba(66, 153, 225, 0.1);
            border: 1px solid #4299e1;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
        }

        .status.success { 
            background: rgba(72, 187, 120, 0.1); 
            border-color: #48bb78; 
            color: #2f855a; 
        }

        .status.warning { 
            background: rgba(237, 137, 54, 0.1); 
            border-color: #ed8936; 
            color: #c05621; 
        }

        .status.error { 
            background: rgba(229, 62, 62, 0.1); 
            border-color: #e53e3e; 
            color: #c53030; 
        }

        .btn {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 8px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(66, 153, 225, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.4);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #48bb78, #38a169);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-submit {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            font-size: 1.3em;
            padding: 18px 40px;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .btn-next {
            background: linear-gradient(45deg, #9f7aea, #805ad5);
            font-size: 1.2em;
            padding: 16px 35px;
            box-shadow: 0 4px 15px rgba(159, 122, 234, 0.3);
        }

        .control-panel {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }

        .beat-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .beat-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8em;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beat-btn:hover {
            transform: scale(1.1);
        }

        .beat-display {
            background: rgba(102, 126, 234, 0.1);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }

        .wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
            padding: 25px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
        }

        .timing-wheel {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 20px 0;
        }

        .wheel-base {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 3px solid #e2e8f0;
            position: relative;
        }

        .wheel-tick {
            position: absolute;
            width: 4px;
            height: 25px;
            background: #4299e1;
            border-radius: 2px;
            top: 7.5px;
            left: 50%;
            margin-left: -2px;
            transform-origin: 50% 100px;
        }

        .wheel-pointer {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            top: 0px;
            left: 50%;
            transform-origin: 50% 100px;
            margin-left: -10px;
            transition: transform 0.4s ease;
            z-index: 10;
            border: 3px solid white;
        }

        .wheel-center {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            top: 50%;
            left: 50%;
            margin: -10px 0 0 -10px;
            z-index: 15;
        }

        .info-box {
            background: linear-gradient(135deg, #ebf8ff, #bee3f8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3182ce;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.8);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #4299e1;
        }

        input[type="text"], input[type="number"], input[type="email"], select, textarea {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 1em;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4299e1;
        }

        .required-field {
            border-color: #e53e3e !important;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #48bb78, #38a169);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="welcome-screen">
            <h1>Rhythm Cycle Alignment Study</h1>
            <p class="subtitle">Musical Rhythm Perception Research</p>
            
            <div style="margin: 40px 0;">
                <button class="btn btn-submit" onclick="startExperiment()">Enter Study</button>
            </div>
        </div>
        
        <div id="experiment-content" style="display: none;">
            <!-- Experiment content will be inserted here -->
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_FORMS: {
                form_url: 'https://docs.google.com/forms/d/e/1FAIpQLSe_FwttiN7E5Ma-8PWgjhbXGww96pp20rOQJdjvZHOw3mLQkw/formResponse',
                fields: {
                    participant_id: 'entry.1163885589',
                    trial_data: 'entry.112861185',
                    age: 'entry.271345687',
                    strategies: 'entry.883232585'
                }
            },
            PRACTICE: {
                example_audio: 'audio/Drum_Example.mp3',
                practice1: {
                    name: 'Practice 1',
                    stm1: 'audio/Stm1_Practice1.mp3',
                    stm2: 'audio/Stm2_Practice1.mp3',
                    beats_per_cycle: 4,
                    beat_duration: 0.37
                },
                practice2: {
                    name: 'Practice 2',
                    stm1: 'audio/Stm1_Practice2.mp3',
                    stm2: 'audio/Stm2_Practice2.mp3',
                    beats_per_cycle: 6,
                    beat_duration: 0.30
                }
            },
            RHYTHMS: [
                {
                    name: 'Jhaptal',
                    stm1: 'audio/Jhaptal_Stm1_5.mp3',
                    stm2: 'audio/Jhaptal_Stm2_5.mp3',
                    beats_per_cycle: 10,
                    beat_duration: 0.500,
                    total_cycles: 24
                },
                {
                    name: 'Keherva',
                    stm1: 'audio/Keherva_Stm1_5.mp3',
                    stm2: 'audio/Keherva_Stm2_5.mp3',
                    beats_per_cycle: 8,
                    beat_duration: 0.625,
                    total_cycles: 24
                },
                {
                    name: 'Rupak',
                    stm1: 'audio/Rupak_Stm1_5.mp3',
                    stm2: 'audio/Rupak_Stm2_5.mp3',
                    beats_per_cycle: 7,
                    beat_duration: 0.714286,
                    total_cycles: 24
                },
                {
                    name: 'Teental',
                    stm1: 'audio/Teental_Stm1_5.mp3',
                    stm2: 'audio/Teental_Stm2_5.mp3',
                    beats_per_cycle: 16,
                    beat_duration: 0.3125,
                    total_cycles: 24
                }
            ],
            REPETITIONS: 2
        };
        
        // Global variables
        let audioContext;
        let audioBuffers = { rhythm: null, tones: null };
        let audioSources = { rhythm: null, tones: null };
        let gainNodes = { rhythm: null, tones: null };
        
        let participantId = 'RHYTHM_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        
        let experimentTrials = [];
        let currentTrialIndex = 0;
        let currentTrial = null;
        let participantAge = '';
        
        let currentBeatOffset = 0;
        let initialBeatOffset = 0;
        let isPlaying = false;
        let currentPlaybackPosition = 0;
        let playbackStartTime = 0;
        let isFirstPlay = true;
        let trialStartTime = 0;
        let adjustmentCount = 0;
        let allTrialData = [];
        let cumulativeWheelAngle = 0;
        
        let practiceStage = 0;
        let currentPractice = null;
        let exampleAudioBuffer = null;
        let exampleAudioSource = null;
        let isExamplePlaying = false;
        let practice1Completed = false;
        let practice2Completed = false;
        let hasPlayedCurrentTrial = false;
        
        let surveyData = {
            indianMusicFamiliarity: '',
            indianMusicGenres: [],
            hindustaniTraining: '',
            hindustaniYears: '',
            musicianType: '',
            musicalTrainingYears: '',
            musicalTrainingType: '',
            nationality: '',
            ethnicity: '',
            age: '',
            hindustaniFamiliarityAnswers: [],
            hindustaniFamiliarityScore: 0
        };
        
        // Initialize audio context
        async function initializeAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                gainNodes.rhythm = audioContext.createGain();
                gainNodes.tones = audioContext.createGain();
                
                gainNodes.rhythm.connect(audioContext.destination);
                gainNodes.tones.connect(audioContext.destination);
                
                gainNodes.rhythm.gain.value = 0.7;
                gainNodes.tones.gain.value = 0.8;
                
                return true;
            } catch (error) {
                console.error('Audio initialization failed:', error);
                return false;
            }
        }
        
        // Load audio buffer
        async function loadAudioBuffer(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Could not load ${url}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                return audioBuffer;
            } catch (error) {
                console.error('Error loading audio:', error);
                throw error;
            }
        }
        
        // Generate trials
        function generateTrials() {
            let trials = [];
            
            for (let rep = 0; rep < CONFIG.REPETITIONS; rep++) {
                for (let rhythm of CONFIG.RHYTHMS) {
                    trials.push({
                        rhythm: rhythm,
                        repetition: rep + 1,
                        trial_id: `${rhythm.name}_${rep + 1}`
                    });
                }
            }
            
            // Shuffle trials
            for (let i = trials.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [trials[i], trials[j]] = [trials[j], trials[i]];
            }
            
            trials.forEach((trial, index) => {
                trial.trial_number = index + 1;
            });
            
            return trials;
        }
        
        // Show consent form
        function showConsentForm() {
            const content = `
                <h2>Study Information</h2>
                <div class="subtitle">Cross-Cultural Comparisons in Rhythm Alignment to Indian Rhythms</div>
                
                <div class="info-box" style="text-align: left;">
                    <p><strong>Researchers:</strong> Miss Nashra Ahmad, Dr Martin Clayton, Dr Tuomas Eerola</p>
                    <p><strong>Contact:</strong> nashra.ahmad@durham.ac.uk</p>
                    
                    <h3>What is this study about?</h3>
                    <p>You'll be matching tones to Indian rhythmic patterns by choosing where you feel the rhythm cycle begins. There are no right or wrong answers.</p>
                    
                    <h3>Consent Statements:</h3>
                    <ul>
                        <li>I confirm that I have read and understand the information</li>
                        <li>I understand my participation is voluntary</li>
                        <li>I agree to take part in this project</li>
                    </ul>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="handleConsent(true)">I consent: Begin Experiment</button>
                    <button class="btn" onclick="handleConsent(false)" style="background: #e53e3e;">I do not consent</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function handleConsent(consented) {
            if (consented) {
                showBackgroundQuestionnaire();
            } else {
                document.getElementById('experiment-content').innerHTML = `
                    <div class="info-box">
                        <h3>Thank you for your time</h3>
                        <p>You have chosen not to participate. You may close this window.</p>
                    </div>
                `;
            }
        }
        
        // Background questionnaire
        function showBackgroundQuestionnaire() {
            const content = `
                <h2>Background Questionnaire</h2>
                <div class="subtitle">Please answer a few questions (* = required)</div>
                
                <div class="info-box" style="text-align: left;">
                    <div style="margin: 20px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                            Are you familiar with Indian music? *
                        </label>
                        <label style="display: block; margin: 8px 0;">
                            <input type="radio" name="indianFamiliarity" value="yes" onchange="toggleIndianMusicQuestions(true)"> Yes
                        </label>
                        <label style="display: block; margin: 8px 0;">
                            <input type="radio" name="indianFamiliarity" value="no" onchange="toggleIndianMusicQuestions(false)"> No
                        </label>
                    </div>
                    
                    <div id="indian-music-questions" style="display: none; background: rgba(102, 126, 234, 0.05); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <div style="margin: 20px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Which genres do you listen to? (Select all that apply)
                            </label>
                            <label><input type="checkbox" value="classical" onchange="updateIndianGenres()"> Indian Classical</label><br>
                            <label><input type="checkbox" value="bollywood" onchange="updateIndianGenres()"> Bollywood</label><br>
                            <label><input type="checkbox" value="carnatic" onchange="updateIndianGenres()"> Carnatic</label><br>
                            <label><input type="checkbox" value="fusion" onchange="updateIndianGenres()"> Fusion</label><br>
                            <label><input type="checkbox" value="other" onchange="updateIndianGenres()"> Other</label>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Trained in Hindustani Classical Music? *
                            </label>
                            <label><input type="radio" name="hindustaniTraining" value="yes"> Yes</label><br>
                            <label><input type="radio" name="hindustaniTraining" value="little"> A little</label><br>
                            <label><input type="radio" name="hindustaniTraining" value="no"> No</label>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Which title best describes you? *
                            </label>
                            <select id="musician-type" style="width: 100%;">
                                <option value="">Please select...</option>
                                <option value="nonmusician">Nonmusician</option>
                                <option value="music-loving">Music-loving nonmusician</option>
                                <option value="amateur">Amateur musician</option>
                                <option value="serious-amateur">Serious amateur musician</option>
                                <option value="semiprofessional">Semiprofessional musician</option>
                                <option value="professional">Professional musician</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="general-music-questions-main" style="display: none; background: rgba(159, 122, 234, 0.05); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <div style="margin: 20px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                                Which title best describes you? *
                            </label>
                            <select id="musician-type-main" style="width: 100%;">
                                <option value="">Please select...</option>
                                <option value="nonmusician">Nonmusician</option>
                                <option value="music-loving">Music-loving nonmusician</option>
                                <option value="amateur">Amateur musician</option>
                                <option value="serious-amateur">Serious amateur musician</option>
                                <option value="semiprofessional">Semiprofessional musician</option>
                                <option value="professional">Professional musician</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Demographics</h3>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">Nationality *</label>
                        <select id="nationality" style="width: 100%;">
                            <option value="">Please select...</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="United States">United States</option>
                            <option value="Canada">Canada</option>
                            <option value="Australia">Australia</option>
                            <option value="India">India</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">Ethnicity *</label>
                        <select id="ethnicity" style="width: 100%;">
                            <option value="">Please select...</option>
                            <option value="White">White</option>
                            <option value="Indian">Indian</option>
                            <option value="Pakistani">Pakistani</option>
                            <option value="Bangladeshi">Bangladeshi</option>
                            <option value="Chinese">Chinese</option>
                            <option value="Black African">Black African</option>
                            <option value="Mixed">Mixed</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">Age *</label>
                        <input type="number" id="age" placeholder="Your age" min="1" max="120" style="width: 100%;">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="submitBackgroundQuestionnaire()">Continue to Instructions</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function toggleIndianMusicQuestions(show) {
            document.getElementById('indian-music-questions').style.display = show ? 'block' : 'none';
            document.getElementById('general-music-questions-main').style.display = show ? 'none' : 'block';
            surveyData.indianMusicFamiliarity = show ? 'yes' : 'no';
        }
        
        function updateIndianGenres() {
            const checkboxes = document.querySelectorAll('#indian-music-questions input[type="checkbox"]:checked');
            surveyData.indianMusicGenres = Array.from(checkboxes).map(cb => cb.value);
        }
        
        function submitBackgroundQuestionnaire() {
            // Validate required fields
            const requiredFields = [];
            
            const indianFamiliarity = document.querySelector('input[name="indianFamiliarity"]:checked');
            if (!indianFamiliarity) requiredFields.push('Indian music familiarity');
            
            surveyData.nationality = document.getElementById('nationality')?.value || '';
            surveyData.ethnicity = document.getElementById('ethnicity')?.value || '';
            surveyData.age = document.getElementById('age')?.value || '';
            
            if (!surveyData.nationality) requiredFields.push('Nationality');
            if (!surveyData.ethnicity) requiredFields.push('Ethnicity');
            if (!surveyData.age) requiredFields.push('Age');
            
            if (surveyData.indianMusicFamiliarity === 'yes') {
                const hindustaniRadio = document.querySelector('input[name="hindustaniTraining"]:checked');
                if (!hindustaniRadio) requiredFields.push('Hindustani training');
                surveyData.hindustaniTraining = hindustaniRadio?.value || '';
                
                surveyData.musicianType = document.getElementById('musician-type')?.value || '';
                if (!surveyData.musicianType) requiredFields.push('Musician type');
            } else {
                surveyData.musicianType = document.getElementById('musician-type-main')?.value || '';
                if (!surveyData.musicianType) requiredFields.push('Musician type');
            }
            
            if (requiredFields.length > 0) {
                updateStatus(`Please complete: ${requiredFields.join(', ')}`, 'warning');
                return;
            }
            
            participantAge = surveyData.age;
            showExamplePage();
        }
        
        function showExamplePage() {
            stopExampleAudio();
            
            const content = `
                <h2>Listen to the Example</h2>
                <div class="subtitle">Understanding the Alignment Task</div>
                
                <div class="instructions">
                    <p>First, listen to how the tone (beep) is aligned with the drum pattern:</p>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="playExampleAudio()">▶ Play Example</button>
                        <button class="btn" onclick="stopExampleAudio()">⏹ Stop</button>
                    </div>
                    
                    <div id="example-status" class="status" style="display: none;"></div>
                    
                    <p>In this example, you can hear how the tones (beeps) are perfectly aligned with the drum pattern.</p>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-next" onclick="showInstructions()">Continue to Practice</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            loadExampleAudio();
        }
        
        async function loadExampleAudio() {
            try {
                updateExampleStatus('Loading example audio...', 'warning');
                const buffer = await loadAudioBuffer(CONFIG.PRACTICE.example_audio);
                exampleAudioBuffer = buffer;
                updateExampleStatus('Example audio loaded!', 'success');
            } catch (error) {
                updateExampleStatus('Audio file not found', 'error');
            }
        }
        
        async function playExampleAudio() {
            if (!exampleAudioBuffer) {
                updateExampleStatus('Example audio not loaded', 'error');
                return;
            }
            
            try {
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                stopExampleAudio();
                
                exampleAudioSource = audioContext.createBufferSource();
                exampleAudioSource.buffer = exampleAudioBuffer;
                exampleAudioSource.connect(audioContext.destination);
                exampleAudioSource.start();
                
                isExamplePlaying = true;
                updateExampleStatus('Playing example...', 'success');
                
                exampleAudioSource.onended = () => {
                    isExamplePlaying = false;
                    updateExampleStatus('Example complete', '');
                    exampleAudioSource = null;
                };
                
            } catch (error) {
                updateExampleStatus('Failed to play example', 'error');
            }
        }
        
        function stopExampleAudio() {
            if (exampleAudioSource) {
                try {
                    exampleAudioSource.stop();
                } catch(e) {}
                exampleAudioSource = null;
            }
            isExamplePlaying = false;
        }
        
        function updateExampleStatus(message, type = '') {
            const statusEl = document.getElementById('example-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
                statusEl.style.display = message ? 'block' : 'none';
            }
        }
        
        function showInstructions() {
            stopExampleAudio();
            
            const content = `
                <h2>Instructions and Practice</h2>
                
                <div class="instructions">
                    <h4>Your Task:</h4>
                    <p>You'll hear a rhythmic cycle with misaligned tones (beeps). Align the tones with where you think the cycle begins.</p>
                    <p>Use ← → arrow keys or buttons below to move the tones.</p>
                </div>
                
                <div style="text-align: center; margin: 10px 0; font-weight: bold;">Practice 1</div>
                
                <div class="control-panel">
                    <div class="beat-display">
                        <div>Practice aligning the tones. Use arrows to adjust timing.</div>
                        <div style="color: #d69e2e; font-weight: bold; margin-top: 8px;">
                            You must align to Beat 1 to continue.
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="playPracticeAudio()">▶ Play</button>
                        <button class="btn" onclick="pauseAudio()">⏸ Pause</button>
                    </div>
                    
                    <div class="beat-controls">
                        <button class="beat-btn" onclick="adjustPracticeBeat(1)">←</button>
                        <div style="text-align: center;">
                            <div style="font-weight: bold;">Timing Control</div>
                            <div style="font-size: 0.9em;">← Earlier | Later →</div>
                        </div>
                        <button class="beat-btn" onclick="adjustPracticeBeat(-1)">→</button>
                    </div>
                    
                    <div class="wheel-container">
                        <div style="font-weight: bold; margin-bottom: 15px;">Visual Indicator</div>
                        <div class="timing-wheel" id="timing-wheel">
                            <div class="wheel-base">
                                <div class="wheel-tick" style="transform: rotate(0deg);"></div>
                                <div class="wheel-pointer" id="wheel-pointer"></div>
                                <div class="wheel-center"></div>
                            </div>
                        </div>
                        <div>Shows current timing adjustment</div>
                    </div>
                    
                    <div id="practice-feedback" style="margin: 20px 0; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; text-align: center;">
                        <div style="margin-bottom: 8px;">Current alignment:</div>
                        <div id="beat-position-display" style="font-size: 1.2em; font-weight: bold; color: #667eea;">Beat 1 (Start of cycle)</div>
                        <div style="font-size: 0.9em; margin-top: 8px;">Goal: Align tones to Beat 1</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-next" id="practice1-continue" onclick="finishPractice1()" disabled>Continue to Practice 2</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            loadAndStartPractice1();
        }
        
        async function loadAndStartPractice1() {
            currentPractice = CONFIG.PRACTICE.practice1;
            await loadPracticeAudio(currentPractice);
            initializePractice();
            updateWheelVisualization();
            updatePracticeFeedback();
        }
        
        async function loadPracticeAudio(practice) {
            try {
                updateStatus(`Loading ${practice.name} audio...`, 'warning');
                
                const [rhythmBuffer, tonesBuffer] = await Promise.all([
                    loadAudioBuffer(practice.stm1),
                    loadAudioBuffer(practice.stm2)
                ]);
                
                audioBuffers.rhythm = rhythmBuffer;
                audioBuffers.tones = tonesBuffer;
                
                updateStatus(`${practice.name} audio loaded!`, 'success');
                return true;
            } catch (error) {
                updateStatus(`Failed to load ${practice.name} audio`, 'error');
                return false;
            }
        }
        
        function initializePractice() {
            initialBeatOffset = Math.floor(Math.random() * (currentPractice.beats_per_cycle - 1)) + 1;
            currentBeatOffset = initialBeatOffset;
            currentPlaybackPosition = 0;
            isFirstPlay = true;
            adjustmentCount = 0;
            cumulativeWheelAngle = 0;
        }
        
        async function playPracticeAudio() {
            if (!audioBuffers.rhythm || !audioBuffers.tones) {
                updateStatus('Practice audio not loaded', 'error');
                return;
            }
            
            try {
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                stopAudio();
                
                const now = audioContext.currentTime + 0.1;
                const toneOffset = currentBeatOffset * currentPractice.beat_duration;
                
                let startPosition;
                if (isFirstPlay) {
                    const randomBeat = Math.floor(Math.random() * currentPractice.beats_per_cycle) + 1;
                    startPosition = (randomBeat - 1) * currentPractice.beat_duration;
                    currentPlaybackPosition = startPosition;
                    isFirstPlay = false;
                } else {
                    startPosition = currentPlaybackPosition;
                }
                
                audioSources.rhythm = audioContext.createBufferSource();
                audioSources.rhythm.buffer = audioBuffers.rhythm;
                audioSources.rhythm.connect(gainNodes.rhythm);
                audioSources.rhythm.start(now, startPosition);
                
                audioSources.tones = audioContext.createBufferSource();
                audioSources.tones.buffer = audioBuffers.tones;
                audioSources.tones.connect(gainNodes.tones);
                audioSources.tones.start(now, startPosition + toneOffset);
                
                isPlaying = true;
                playbackStartTime = now;
                
                updateStatus('Playing practice...', 'success');
                
                const remainingDuration = audioBuffers.rhythm.duration - startPosition;
                setTimeout(() => {
                    if (isPlaying) {
                        currentPlaybackPosition = 0;
                        isFirstPlay = true;
                        stopAudio();
                        updateStatus('Practice finished', '');
                    }
                }, remainingDuration * 1000);
                
            } catch (error) {
                updateStatus('Practice audio failed', 'error');
            }
        }
        
        function adjustPracticeBeat(direction) {
            let newOffset = currentBeatOffset + direction;
            
            if (newOffset >= currentPractice.beats_per_cycle) {
                newOffset = 0;
            } else if (newOffset < 0) {
                newOffset = currentPractice.beats_per_cycle - 1;
            }
            
            currentBeatOffset = newOffset;
            adjustmentCount++;
            
            const anglePerBeat = 360 / currentPractice.beats_per_cycle;
            cumulativeWheelAngle -= direction * anglePerBeat;
            
            updateWheelVisualization();
            updatePracticeFeedback();
            
            if (isPlaying) {
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                playPracticeAudio();
            }
        }
        
        function updatePracticeFeedback() {
            const display = document.getElementById('beat-position-display');
            if (!display) return;
            
            const beatNumber = currentBeatOffset + 1;
            
            if (currentBeatOffset === 0) {
                display.innerHTML = `Beat 1 (Start of cycle) ✓`;
                display.style.color = '#38a169';
                
                if (practiceStage === 0) {
                    practice1Completed = true;
                    const continueBtn = document.getElementById('practice1-continue');
                    if (continueBtn) {
                        continueBtn.disabled = false;
                        continueBtn.style.background = 'linear-gradient(45deg, #9f7aea, #805ad5)';
                    }
                } else if (practiceStage === 1) {
                    practice2Completed = true;
                    const continueBtn = document.getElementById('practice2-continue');
                    if (continueBtn) {
                        continueBtn.disabled = false;
                        continueBtn.style.background = 'linear-gradient(45deg, #9f7aea, #805ad5)';
                    }
                }
            } else {
                display.innerHTML = `Beat ${beatNumber} of ${currentPractice.beats_per_cycle}`;
                display.style.color = '#667eea';
                
                if (practiceStage === 0) {
                    practice1Completed = false;
                    const continueBtn = document.getElementById('practice1-continue');
                    if (continueBtn) {
                        continueBtn.disabled = true;
                        continueBtn.style.background = '#a0aec0';
                    }
                } else if (practiceStage === 1) {
                    practice2Completed = false;
                    const continueBtn = document.getElementById('practice2-continue');
                    if (continueBtn) {
                        continueBtn.disabled = true;
                        continueBtn.style.background = '#a0aec0';
                    }
                }
            }
        }
        
        function finishPractice1() {
            if (!practice1Completed) {
                updateStatus('Please align to Beat 1 before continuing', 'warning');
                return;
            }
            
            stopAudio();
            practiceStage = 1;
            showPractice2();
        }
        
        function showPractice2() {
            currentPractice = CONFIG.PRACTICE.practice2;
            
            const content = `
                <div style="text-align: center; margin: 10px 0; font-weight: bold;">Practice 2</div>
                
                <div class="control-panel">
                    <div class="beat-display">
                        <div>Second practice round. Get comfortable with the controls.</div>
                        <div style="color: #d69e2e; font-weight: bold; margin-top: 8px;">
                            You must align to Beat 1 to continue.
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="playPracticeAudio()">▶ Play</button>
                        <button class="btn" onclick="pauseAudio()">⏸ Pause</button>
                    </div>
                    
                    <div class="beat-controls">
                        <button class="beat-btn" onclick="adjustPracticeBeat(1)">←</button>
                        <div style="text-align: center;">
                            <div style="font-weight: bold;">Timing Control</div>
                            <div style="font-size: 0.9em;">← Earlier | Later →</div>
                        </div>
                        <button class="beat-btn" onclick="adjustPracticeBeat(-1)">→</button>
                    </div>
                    
                    <div class="wheel-container">
                        <div style="font-weight: bold; margin-bottom: 15px;">Visual Indicator</div>
                        <div class="timing-wheel" id="timing-wheel">
                            <div class="wheel-base">
                                <div class="wheel-tick" style="transform: rotate(0deg);"></div>
                                <div class="wheel-pointer" id="wheel-pointer"></div>
                                <div class="wheel-center"></div>
                            </div>
                        </div>
                        <div>Shows current timing adjustment</div>
                    </div>
                    
                    <div id="practice-feedback" style="margin: 20px 0; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; text-align: center;">
                        <div style="margin-bottom: 8px;">Current alignment:</div>
                        <div id="beat-position-display" style="font-size: 1.2em; font-weight: bold; color: #667eea;">Beat 1 (Start of cycle)</div>
                        <div style="font-size: 0.9em; margin-top: 8px;">Goal: Align tones to Beat 1</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-next" id="practice2-continue" onclick="finishPractice2()" disabled>Ready for Main Experiment</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            
            loadPracticeAudio(currentPractice).then(() => {
                initializePractice();
                updateWheelVisualization();
            });
        }
        
        function finishPractice2() {
            if (!practice2Completed) {
                updateStatus('Please align to Beat 1 before continuing', 'warning');
                return;
            }
            
            stopAudio();
            practiceStage = 2;
            showExperimentInstructions();
        }
        
        function showExperimentInstructions() {
            const content = `
                <div class="instructions">
                    <h3>Ready for the Main Experiment</h3>
                    <p>Now align the tones with what you think is the first beat of the Indian rhythmic cycle.</p>
                    <ul>
                        <li><strong>Experiment:</strong> ${experimentTrials.length} trials with different rhythms</li>
                        <li><strong>Controls:</strong> Use ← → arrows to shift the tones</li>
                        <li><strong>Goal:</strong> Find where tones align best with the rhythm's first beat</li>
                    </ul>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startFirstTrial()">Begin Experiment</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        async function startFirstTrial() {
            currentTrialIndex = 0;
            await startTrial();
        }
        
        async function startTrial() {
            if (currentTrialIndex >= experimentTrials.length) {
                askAboutStrategies();
                return;
            }
            
            currentTrial = experimentTrials[currentTrialIndex];
            hasPlayedCurrentTrial = false;
            
            updateStatus(`Loading trial ${currentTrial.trial_number}...`, 'warning');
            
            const audioLoaded = await loadTrialAudio(currentTrial);
            if (!audioLoaded) return;
            
            initialBeatOffset = Math.floor(Math.random() * (currentTrial.rhythm.beats_per_cycle - 1)) + 1;
            currentBeatOffset = initialBeatOffset;
            trialStartTime = Date.now();
            adjustmentCount = 0;
            currentPlaybackPosition = 0;
            isFirstPlay = true;
            cumulativeWheelAngle = 0;
            
            const content = `
                <div style="text-align: center; margin: 10px 0; font-weight: bold;">Trial ${currentTrial.trial_number} of ${experimentTrials.length}</div>
                
                <div class="control-panel">
                    <div class="beat-display">
                        <div>Use arrows to adjust timing. You can adjust while playing.</div>
                        <div style="color: #d69e2e; font-weight: bold; margin-top: 8px;">
                            You must play the audio at least once before submitting.
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="playAudio()">▶ Play</button>
                        <button class="btn" onclick="pauseAudio()">⏸ Pause</button>
                    </div>
                    
                    <div class="beat-controls">
                        <button class="beat-btn" onclick="adjustBeat(1)">←</button>
                        <div style="text-align: center;">
                            <div style="font-weight: bold;">Timing Control</div>
                            <div style="font-size: 0.9em;">← Earlier | Later →</div>
                        </div>
                        <button class="beat-btn" onclick="adjustBeat(-1)">→</button>
                    </div>
                    
                    <div class="wheel-container">
                        <div style="font-weight: bold; margin-bottom: 15px;">Visual Indicator</div>
                        <div class="timing-wheel" id="timing-wheel">
                            <div class="wheel-base">
                                <div class="wheel-tick" style="transform: rotate(0deg);"></div>
                                <div class="wheel-pointer" id="wheel-pointer"></div>
                                <div class="wheel-center"></div>
                            </div>
                        </div>
                        <div>Shows current timing adjustment</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-submit" id="submit-trial-btn" onclick="submitTrial()" disabled>Submit This Trial</button>
                    </div>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            updateStatus('Ready! Click Play and use arrows to adjust.', '');
            
            updateWheelVisualization();
        }
        
        async function loadTrialAudio(trial) {
            try {
                updateStatus(`Loading audio for ${trial.rhythm.name}...`, 'warning');
                
                const [rhythmBuffer, tonesBuffer] = await Promise.all([
                    loadAudioBuffer(trial.rhythm.stm1),
                    loadAudioBuffer(trial.rhythm.stm2)
                ]);
                
                audioBuffers.rhythm = rhythmBuffer;
                audioBuffers.tones = tonesBuffer;
                
                updateStatus(`Audio loaded for ${trial.rhythm.name}!`, 'success');
                return true;
            } catch (error) {
                updateStatus(`Failed to load audio for ${trial.rhythm.name}`, 'error');
                return false;
            }
        }
        
        async function playAudio() {
            if (!audioBuffers.rhythm || !audioBuffers.tones) {
                updateStatus('Audio not loaded', 'error');
                return;
            }
            
            try {
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                if (!hasPlayedCurrentTrial) {
                    hasPlayedCurrentTrial = true;
                    const submitBtn = document.getElementById('submit-trial-btn');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.style.background = 'linear-gradient(45deg, #e53e3e, #c53030)';
                    }
                }
                
                stopAudio();
                
                const now = audioContext.currentTime + 0.1;
                const toneOffset = currentBeatOffset * currentTrial.rhythm.beat_duration;
                
                let startPosition;
                if (isFirstPlay) {
                    const randomBeat = Math.floor(Math.random() * currentTrial.rhythm.beats_per_cycle) + 1;
                    startPosition = (randomBeat - 1) * currentTrial.rhythm.beat_duration;
                    currentPlaybackPosition = startPosition;
                    isFirstPlay = false;
                } else {
                    startPosition = currentPlaybackPosition;
                }
                
                audioSources.rhythm = audioContext.createBufferSource();
                audioSources.rhythm.buffer = audioBuffers.rhythm;
                audioSources.rhythm.connect(gainNodes.rhythm);
                audioSources.rhythm.start(now, startPosition);
                
                audioSources.tones = audioContext.createBufferSource();
                audioSources.tones.buffer = audioBuffers.tones;
                audioSources.tones.connect(gainNodes.tones);
                audioSources.tones.start(now, startPosition + toneOffset);
                
                gainNodes.rhythm.gain.setValueAtTime(0.7, now);
                gainNodes.tones.gain.setValueAtTime(0.8, now);
                
                isPlaying = true;
                playbackStartTime = now;
                
                updateStatus('Playing...', 'success');
                
                const remainingDuration = audioBuffers.rhythm.duration - startPosition;
                setTimeout(() => {
                    if (isPlaying) {
                        currentPlaybackPosition = 0;
                        isFirstPlay = true;
                        stopAudio();
                        updateStatus('Audio finished', '');
                    }
                }, remainingDuration * 1000);
                
            } catch (error) {
                updateStatus('Audio playback failed', 'error');
            }
        }
        
        function pauseAudio() {
            if (isPlaying) {
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                
                if (currentPlaybackPosition >= audioBuffers.rhythm.duration) {
                    currentPlaybackPosition = 0;
                }
            }
            
            stopAudio();
            updateStatus('Paused', '');
        }
        
        function adjustBeat(direction) {
            let newOffset = currentBeatOffset + direction;
            
            if (newOffset >= currentTrial.rhythm.beats_per_cycle) {
                newOffset = 0;
            } else if (newOffset < 0) {
                newOffset = currentTrial.rhythm.beats_per_cycle - 1;
            }
            
            currentBeatOffset = newOffset;
            adjustmentCount++;
            
            const anglePerBeat = 360 / currentTrial.rhythm.beats_per_cycle;
            cumulativeWheelAngle -= direction * anglePerBeat;
            
            updateWheelVisualization();
            
            if (isPlaying) {
                const elapsedTime = audioContext.currentTime - playbackStartTime;
                currentPlaybackPosition += elapsedTime;
                playAudio();
                updateStatus('Alignment adjusted', 'success');
            } else {
                updateStatus('Adjustment made', '');
            }
        }
        
        function updateWheelVisualization() {
            const pointer = document.getElementById('wheel-pointer');
            if (pointer) {
                pointer.style.transform = `rotate(${cumulativeWheelAngle}deg)`;
            }
        }
        
        function submitTrial() {
            if (!hasPlayedCurrentTrial) {
                updateStatus('Please play the audio at least once', 'warning');
                return;
            }
            
            pauseAudio();
            
            const trialDuration = Date.now() - trialStartTime;
            const correctBeat = 0;
            const errorBeats = currentBeatOffset - correctBeat;
            const absoluteError = Math.abs(errorBeats);
            
            const trialData = {
                trial_number: currentTrial.trial_number,
                trial_id: currentTrial.trial_id,
                rhythm_name: currentTrial.rhythm.name,
                repetition: currentTrial.repetition,
                beats_per_cycle: currentTrial.rhythm.beats_per_cycle,
                initial_beat_offset: initialBeatOffset,
                final_beat_offset: currentBeatOffset,
                correct_beat_offset: correctBeat,
                error_beats: errorBeats,
                absolute_error_beats: absoluteError,
                total_adjustments: adjustmentCount,
                trial_duration_ms: trialDuration,
                trial_duration_sec: Math.round(trialDuration / 100) / 10
            };
            
            allTrialData.push(trialData);
            
            updateStatus('Trial completed!', 'success');
            
            currentTrialIndex++;
            
            if (currentTrialIndex >= experimentTrials.length) {
                setTimeout(() => askAboutStrategies(), 1500);
            } else {
                setTimeout(() => showNextTrialPrompt(), 1500);
            }
        }
        
        function showNextTrialPrompt() {
            const remaining = experimentTrials.length - currentTrialIndex;
            const lastTrial = allTrialData[allTrialData.length - 1];
            const alignedBeat = lastTrial.final_beat_offset + 1;
            
            let feedbackMessage = '';
            let feedbackColor = '';
            
            if (alignedBeat === 1) {
                feedbackMessage = "You aligned it to the first beat of the cycle. That is how an expert would do it.";
                feedbackColor = "#38a169";
            } else {
                feedbackMessage = `You aligned the cycle to the ${getOrdinal(alignedBeat)} beat. An expert would align it to the 1st beat.`;
                feedbackColor = "#d69e2e";
            }
            
            const content = `
                <div class="info-box">
                    <p style="color: ${feedbackColor}; font-weight: bold; font-size: 1.2em; text-align: center;">${feedbackMessage}</p>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <p>${remaining} more trial${remaining !== 1 ? 's' : ''} to go.</p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-next" onclick="startTrial()">Continue to Next Trial</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function getOrdinal(num) {
            const suffix = ["th", "st", "nd", "rd"];
            const v = num % 100;
            return num + (suffix[(v - 20) % 10] || suffix[v] || suffix[0]);
        }
        
        function askAboutStrategies() {
            const content = `
                <div class="info-box">
                    <h3>All ${experimentTrials.length} trials completed!</h3>
                    
                    <div style="margin: 25px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                            What strategies did you use during this task? * (Required)
                        </label>
                        <textarea id="strategies" 
                                style="width: 100%; min-height: 120px;"
                                placeholder="Please describe any strategies, approaches, or things you focused on..."></textarea>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveStrategiesAndShowResults()">Continue to Results</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function saveStrategiesAndShowResults() {
            const strategies = document.getElementById('strategies')?.value || '';
            
            if (!strategies.trim()) {
                updateStatus('Please describe your strategies (required)', 'warning');
                const textarea = document.getElementById('strategies');
                if (textarea) {
                    textarea.classList.add('required-field');
                    textarea.focus();
                }
                return;
            }
            
            createParticipantRecord(strategies);
            showFinalResults();
        }
        
        function createParticipantRecord(strategies = '', taskFeedback = '') {
            const correctTrials = allTrialData.filter(trial => trial.final_beat_offset === 0).length;
            const totalTrials = allTrialData.length;
            
            const participantRecord = {
                participant_id: participantId,
                timestamp: new Date().toISOString(),
                age: participantAge,
                nationality: surveyData.nationality,
                ethnicity: surveyData.ethnicity,
                indian_music_familiarity: surveyData.indianMusicFamiliarity,
                musician_type: surveyData.musicianType,
                total_trials: totalTrials,
                correct_trials: correctTrials,
                accuracy_percent: Math.round((correctTrials / totalTrials) * 100),
                participant_strategies: strategies,
                task_feedback: taskFeedback
            };
            
            allTrialData = [participantRecord];
        }
        
        function showFinalResults() {
            const participantRecord = allTrialData[0];
            const totalTrials = participantRecord.total_trials;
            const correctTrials = participantRecord.correct_trials;
            
            const content = `
                <div class="info-box">
                    <h3 style="text-align: center;">Your Overall Performance</h3>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="font-size: 3em; font-weight: bold; color: #667eea; margin-bottom: 15px;">
                            ${correctTrials}/${totalTrials}
                        </div>
                        <div style="font-size: 1.3em; margin-bottom: 10px;">
                            Rhythmic cycles aligned on the first beat
                        </div>
                    </div>
                    
                    <p style="line-height: 1.6;">
                        Your result is not a reflection of your musical ability. These rhythms require specialized learning to recognize accurately. Performance depends on your cultural background and musical training.
                    </p>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <p>Thank you for participating! Your data helps us understand rhythm perception across different backgrounds.</p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="askTaskFeedback()">Continue</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function askTaskFeedback() {
            const content = `
                <div class="info-box">
                    <h3>Help us improve this experiment</h3>
                    
                    <div style="margin: 25px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                            What did you think about this task? (Optional)
                        </label>
                        <textarea id="task-feedback" 
                                style="width: 100%; min-height: 120px;"
                                placeholder="Any thoughts about the experiment, interface, or suggestions..."></textarea>
                    </div>
                    
                    <div style="margin: 25px 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 10px;">
                            Email for future studies? (Optional)
                        </label>
                        <input type="email" id="participant-email" 
                                style="width: 100%;"
                                placeholder="your.email@example.com">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="finishExperiment()">Complete Experiment</button>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function finishExperiment() {
            const taskFeedback = document.getElementById('task-feedback')?.value || '';
            const participantEmail = document.getElementById('participant-email')?.value || '';
            
            if (allTrialData.length > 0) {
                allTrialData[0].task_feedback = taskFeedback;
                allTrialData[0].participant_email = participantEmail;
            }
            
            const content = `
                <div class="info-box">
                    <h3>Experiment Complete!</h3>
                    <p>Submitting your data...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress"></div>
                    </div>
                </div>
                
                <div id="submission-status" class="status warning">Submitting data...</div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
            
            setTimeout(() => {
                document.getElementById('progress').style.width = '100%';
                submitData();
            }, 500);
        }
        
        async function submitData() {
            try {
                const csvData = convertToCSV(allTrialData);
                await submitToGoogleForms(csvData);
                showFinalCompletion();
            } catch (error) {
                document.getElementById('submission-status').innerHTML = 'Submission complete';
                showFinalCompletion();
            }
        }
        
        async function submitToGoogleForms(csvData) {
            const formData = new FormData();
            formData.append(CONFIG.GOOGLE_FORMS.fields.participant_id, participantId);
            formData.append(CONFIG.GOOGLE_FORMS.fields.trial_data, csvData);
            
            if (participantAge) {
                formData.append(CONFIG.GOOGLE_FORMS.fields.age, participantAge);
            }
            
            if (allTrialData.length > 0 && allTrialData[0].participant_strategies) {
                formData.append(CONFIG.GOOGLE_FORMS.fields.strategies, allTrialData[0].participant_strategies);
            }
            
            await fetch(CONFIG.GOOGLE_FORMS.form_url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            });
        }
        
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(row => 
                Object.values(row).map(value => 
                    typeof value === 'string' ? `"${value}"` : value
                ).join(',')
            );
            
            return headers + '\n' + rows.join('\n');
        }
        
        function showFinalCompletion() {
            const content = `
                <div class="status success">All data submitted successfully!</div>
                
                <div class="info-box">
                    <h3>Thank You!</h3>
                    <p>You have successfully completed the rhythm alignment study. Your participation contributes valuable insights to our understanding of cross-cultural rhythm perception.</p>
                    <br>
                    <p style="text-align: center;">You may now close this window.</p>
                </div>
            `;
            
            document.getElementById('experiment-content').innerHTML = content;
        }
        
        function stopAudio() {
            Object.values(audioSources).forEach(source => {
                if (source) {
                    try { source.stop(); } catch(e) {}
                }
            });
            audioSources.rhythm = null;
            audioSources.tones = null;
            isPlaying = false;
        }
        
        function updateStatus(message, type = '') {
            const statusEl = document.getElementById('submission-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }
        }
        
        // Start experiment
        async function startExperiment() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('experiment-content').style.display = 'block';
            
            const audioInit = await initializeAudio();
            if (!audioInit) {
                updateStatus('Audio initialization failed', 'error');
                return;
            }
            
            experimentTrials = generateTrials();
            showConsentForm();
        }
        
        // Keyboard controls
        document.addEventListener('keydown', (event) => {
            if (document.querySelector('.control-panel')) {
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    if (currentPractice) {
                        adjustPracticeBeat(1);
                    } else {
                        adjustBeat(1);
                    }
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    if (currentPractice) {
                        adjustPracticeBeat(-1);
                    } else {
                        adjustBeat(-1);
                    }
                } else if (event.key === ' ') {
                    event.preventDefault();
                    if (isPlaying) {
                        pauseAudio();
                    } else {
                        if (currentPractice) {
                            playPracticeAudio();
                        } else {
                            playAudio();
                        }
                    }
                }
            }
        });
        
        // Make functions globally available
        window.startExperiment = startExperiment;
        window.handleConsent = handleConsent;
        window.toggleIndianMusicQuestions = toggleIndianMusicQuestions;
        window.updateIndianGenres = updateIndianGenres;
        window.submitBackgroundQuestionnaire = submitBackgroundQuestionnaire;
        window.showInstructions = showInstructions;
        window.playExampleAudio = playExampleAudio;
        window.stopExampleAudio = stopExampleAudio;
        window.playPracticeAudio = playPracticeAudio;
        window.adjustPracticeBeat = adjustPracticeBeat;
        window.finishPractice1 = finishPractice1;
        window.finishPractice2 = finishPractice2;
        window.startFirstTrial = startFirstTrial;
        window.playAudio = playAudio;
        window.pauseAudio = pauseAudio;
        window.adjustBeat = adjustBeat;
        window.submitTrial = submitTrial;
        window.startTrial = startTrial;
        window.saveStrategiesAndShowResults = saveStrategiesAndShowResults;
        window.askTaskFeedback = askTaskFeedback;
        window.finishExperiment = finishExperiment;
        
    </script>
</body>
</html>